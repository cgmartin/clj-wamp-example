<html>
 <head>
  <link rel="stylesheet" href="../coverage.css"/>  <title> clj_wamp/server.clj </title>
 </head>
 <body>
<span class="partial" title="42 out of 44 forms covered">
                 001&nbsp;&nbsp;(ns&nbsp;clj-wamp.server
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 002&nbsp;&nbsp;&nbsp;&nbsp;^{:author&nbsp;"Christopher&nbsp;Martin"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 003&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:doc&nbsp;"Clojure&nbsp;implementation&nbsp;of&nbsp;the&nbsp;WebSocket&nbsp;Application&nbsp;Messaging&nbsp;Protocol"}
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 004&nbsp;&nbsp;&nbsp;&nbsp;(:use&nbsp;[clojure.core.incubator&nbsp;:only&nbsp;[dissoc-in]]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 005&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[clojure.string&nbsp;:only&nbsp;[split]])
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 006&nbsp;&nbsp;&nbsp;&nbsp;(:require&nbsp;[clojure.java.io&nbsp;:as&nbsp;io]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 007&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[org.httpkit.server&nbsp;:as&nbsp;httpkit]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 008&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cheshire.core&nbsp;:as&nbsp;json]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 009&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[clojure.tools.logging&nbsp;:as&nbsp;log]))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 010&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 011&nbsp;&nbsp;(declare&nbsp;send!)
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 012&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 013&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-WELCOME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0)&nbsp;;&nbsp;Server-to-client&nbsp;(Aux)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 014&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-PREFIX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1)&nbsp;;&nbsp;Client-to-server&nbsp;(Aux)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 015&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-CALL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2)&nbsp;;&nbsp;Client-to-server&nbsp;(RPC)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 016&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-CALLRESULT&nbsp;&nbsp;3)&nbsp;;&nbsp;Server-to-client&nbsp;(RPC)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 017&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-CALLERROR&nbsp;&nbsp;&nbsp;4)&nbsp;;&nbsp;Server-to-client&nbsp;(RPC)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 018&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-SUBSCRIBE&nbsp;&nbsp;&nbsp;5)&nbsp;;&nbsp;Client-to-server&nbsp;(PubSub)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 019&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-UNSUBSCRIBE&nbsp;6)&nbsp;;&nbsp;Client-to-server&nbsp;(PubSub)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 020&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-PUBLISH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7)&nbsp;;&nbsp;Client-to-server&nbsp;(PubSub)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 021&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-EVENT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8)&nbsp;;&nbsp;Server-to-client&nbsp;(PubSub)
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 022&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 023&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-BASE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"http://api.wamp.ws/")
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 024&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-ERROR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(str&nbsp;URI-WAMP-BASE&nbsp;"error#"))
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 025&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-PROCEDURE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(str&nbsp;URI-WAMP-BASE&nbsp;"procedure#"))
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 026&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-TOPIC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(str&nbsp;URI-WAMP-BASE&nbsp;"topic#"))
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 027&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-ERROR-GENERIC&nbsp;&nbsp;&nbsp;(str&nbsp;URI-WAMP-ERROR&nbsp;"generic"))
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 028&nbsp;&nbsp;(def&nbsp;^:const&nbsp;DESC-WAMP-ERROR-GENERIC&nbsp;&nbsp;"generic&nbsp;error")
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 029&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-ERROR-INTERNAL&nbsp;&nbsp;(str&nbsp;URI-WAMP-ERROR&nbsp;"internal"))
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 030&nbsp;&nbsp;(def&nbsp;^:const&nbsp;DESC-WAMP-ERROR-INTERNAL&nbsp;"internal&nbsp;error")
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 031&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-ERROR-NOTFOUND&nbsp;&nbsp;(str&nbsp;URI-WAMP-ERROR&nbsp;"notfound"))
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 032&nbsp;&nbsp;(def&nbsp;^:const&nbsp;DESC-WAMP-ERROR-NOTFOUND&nbsp;"not&nbsp;found&nbsp;error")
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 033&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 034&nbsp;&nbsp;(def&nbsp;project-version&nbsp;"clj-wamp/0.6.1")
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 035&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 036&nbsp;&nbsp;(def&nbsp;max-sess-id&nbsp;(atom&nbsp;0))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 037&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 038&nbsp;&nbsp;(defn-&nbsp;next-sess-id&nbsp;[]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 039&nbsp;&nbsp;&nbsp;&nbsp;(swap!&nbsp;max-sess-id&nbsp;inc))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 040&nbsp;&nbsp;
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 041&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 042&nbsp;&nbsp;;;&nbsp;Client&nbsp;utils
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 043&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 044&nbsp;&nbsp;(def&nbsp;client-channels&nbsp;(ref&nbsp;{}))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 045&nbsp;&nbsp;(def&nbsp;client-prefixes&nbsp;(ref&nbsp;{}))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 046&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 047&nbsp;&nbsp;(defn&nbsp;add-client
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 048&nbsp;&nbsp;&nbsp;&nbsp;"add&nbsp;a&nbsp;websocket&nbsp;client&nbsp;with&nbsp;it's&nbsp;corresponding&nbsp;event&nbsp;channel&nbsp;to&nbsp;a&nbsp;map&nbsp;of&nbsp;clients"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 049&nbsp;&nbsp;&nbsp;&nbsp;[channel]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 050&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[sess-id&nbsp;(str&nbsp;(System/currentTimeMillis)&nbsp;"-"&nbsp;(next-sess-id))]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 051&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync&nbsp;(alter&nbsp;client-channels&nbsp;assoc&nbsp;sess-id&nbsp;channel))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 052&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sess-id))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 053&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 054&nbsp;&nbsp;(defn&nbsp;get-client-channel
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 055&nbsp;&nbsp;&nbsp;&nbsp;"returns&nbsp;the&nbsp;channel&nbsp;for&nbsp;a&nbsp;websocket&nbsp;client"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 056&nbsp;&nbsp;&nbsp;&nbsp;[sess-id]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 057&nbsp;&nbsp;&nbsp;&nbsp;(dosync&nbsp;(get&nbsp;@client-channels&nbsp;sess-id)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 058&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 059&nbsp;&nbsp;(defn&nbsp;del-client
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 060&nbsp;&nbsp;&nbsp;&nbsp;"remove&nbsp;a&nbsp;websocket&nbsp;session&nbsp;from&nbsp;the&nbsp;map&nbsp;of&nbsp;clients"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 061&nbsp;&nbsp;&nbsp;&nbsp;[sess-id]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 062&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 063&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;client-channels&nbsp;dissoc&nbsp;sess-id)
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 064&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;client-prefixes&nbsp;dissoc&nbsp;sess-id)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 065&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 066&nbsp;&nbsp;(defn&nbsp;add-prefix
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 067&nbsp;&nbsp;&nbsp;&nbsp;"add&nbsp;a&nbsp;new&nbsp;curi&nbsp;prefix&nbsp;for&nbsp;a&nbsp;websocket&nbsp;client"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 068&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;prefix&nbsp;uri]
                </span><br/>
<span class="partial" title="9 out of 21 forms covered">
                 069&nbsp;&nbsp;&nbsp;&nbsp;(log/trace&nbsp;"New&nbsp;CURI&nbsp;Prefix&nbsp;["&nbsp;sess-id&nbsp;"]"&nbsp;prefix&nbsp;uri)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 070&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 071&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;client-prefixes&nbsp;assoc-in&nbsp;[sess-id&nbsp;prefix]&nbsp;uri)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 072&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 073&nbsp;&nbsp;(defn&nbsp;get-topic
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 074&nbsp;&nbsp;&nbsp;&nbsp;"get&nbsp;a&nbsp;full&nbsp;topic&nbsp;uri&nbsp;from&nbsp;a&nbsp;prefix"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 075&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;curi]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 076&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[topic&nbsp;(split&nbsp;curi&nbsp;#":")
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 077&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prefix&nbsp;(first&nbsp;topic)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 078&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;suffix&nbsp;(second&nbsp;topic)]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 079&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="14 out of 14 forms covered">
                 080&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[uri&nbsp;(get-in&nbsp;@client-prefixes&nbsp;[sess-id&nbsp;prefix])]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 081&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(str&nbsp;uri&nbsp;suffix)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 082&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curi))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 083&nbsp;&nbsp;
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 084&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 085&nbsp;&nbsp;;;&nbsp;Topic&nbsp;utils
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 086&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 087&nbsp;&nbsp;(def&nbsp;client-topics&nbsp;(ref&nbsp;{}))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 088&nbsp;&nbsp;(def&nbsp;topic-clients&nbsp;(ref&nbsp;{}))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 089&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 090&nbsp;&nbsp;(defn&nbsp;topic-subscribe
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 091&nbsp;&nbsp;&nbsp;&nbsp;"subscribe&nbsp;a&nbsp;websocket&nbsp;session&nbsp;to&nbsp;a&nbsp;topic"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 092&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;sess-id]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 093&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 094&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;topic-clients&nbsp;assoc-in&nbsp;[topic&nbsp;sess-id]&nbsp;true)
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 095&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;client-topics&nbsp;assoc-in&nbsp;[sess-id&nbsp;topic]&nbsp;true)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 096&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 097&nbsp;&nbsp;(defn&nbsp;topic-unsubscribe
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 098&nbsp;&nbsp;&nbsp;&nbsp;"unsubscribe&nbsp;a&nbsp;websocket&nbsp;session&nbsp;from&nbsp;a&nbsp;topic"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 099&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;sess-id]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 100&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 101&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;topic-clients&nbsp;dissoc-in&nbsp;[topic&nbsp;sess-id])
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 102&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;client-topics&nbsp;dissoc-in&nbsp;[sess-id&nbsp;topic])))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 103&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 104&nbsp;&nbsp;(defn-&nbsp;topic-send!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 105&nbsp;&nbsp;&nbsp;&nbsp;"send&nbsp;an&nbsp;event&nbsp;to&nbsp;all&nbsp;websocket&nbsp;clients&nbsp;subscribed&nbsp;to&nbsp;a&nbsp;topic"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 106&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;&&nbsp;data]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 107&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="partial" title="45 out of 65 forms covered">
                 108&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(doseq&nbsp;[[sess-id&nbsp;_]&nbsp;(@topic-clients&nbsp;topic)]
                </span><br/>
<span class="partial" title="5 out of 10 forms covered">
                 109&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;send!&nbsp;sess-id&nbsp;data))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 110&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 111&nbsp;&nbsp;(defn-&nbsp;topic-broadcast!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 112&nbsp;&nbsp;&nbsp;&nbsp;"send&nbsp;an&nbsp;event&nbsp;to&nbsp;websocket&nbsp;clients&nbsp;subscribed&nbsp;to&nbsp;a&nbsp;topic,&nbsp;except&nbsp;those&nbsp;excluded"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 113&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;excludes&nbsp;&&nbsp;data]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 114&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[excludes&nbsp;(if&nbsp;(sequential?&nbsp;excludes)&nbsp;excludes&nbsp;[excludes])]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 115&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="partial" title="45 out of 65 forms covered">
                 116&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(doseq&nbsp;[[sess-id&nbsp;_]&nbsp;(@topic-clients&nbsp;topic)]
                </span><br/>
<span class="partial" title="6 out of 12 forms covered">
                 117&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(not-any?&nbsp;#{sess-id}&nbsp;excludes)
                </span><br/>
<span class="partial" title="5 out of 10 forms covered">
                 118&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;send!&nbsp;sess-id&nbsp;data))))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 119&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 120&nbsp;&nbsp;(defn-&nbsp;topic-emit!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 121&nbsp;&nbsp;&nbsp;&nbsp;"send&nbsp;an&nbsp;event&nbsp;to&nbsp;specific&nbsp;websocket&nbsp;clients&nbsp;subscribed&nbsp;to&nbsp;a&nbsp;topic"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 122&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;includes&nbsp;&&nbsp;data]
                </span><br/>
<span class="partial" title="6 out of 8 forms covered">
                 123&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[includes&nbsp;(if&nbsp;(sequential?&nbsp;includes)&nbsp;includes&nbsp;[includes])]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 124&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="partial" title="45 out of 65 forms covered">
                 125&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(doseq&nbsp;[[sess-id&nbsp;_]&nbsp;(@topic-clients&nbsp;topic)]
                </span><br/>
<span class="partial" title="6 out of 12 forms covered">
                 126&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(some&nbsp;#{sess-id}&nbsp;includes)
                </span><br/>
<span class="partial" title="5 out of 10 forms covered">
                 127&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;send!&nbsp;sess-id&nbsp;data))))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 128&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 129&nbsp;&nbsp;(defn&nbsp;get-topic-clients&nbsp;[topic]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 130&nbsp;&nbsp;&nbsp;&nbsp;"get&nbsp;all&nbsp;client&nbsp;session&nbsp;ids&nbsp;within&nbsp;a&nbsp;topic"
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 131&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="partial" title="10 out of 11 forms covered">
                 132&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[clients&nbsp;(@topic-clients&nbsp;topic)]
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 133&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(keys&nbsp;clients))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 134&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 135&nbsp;&nbsp;;;&nbsp;WAMP&nbsp;websocket&nbsp;send!&nbsp;utils
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 136&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 137&nbsp;&nbsp;(defn-&nbsp;send!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 138&nbsp;&nbsp;&nbsp;&nbsp;"send&nbsp;data&nbsp;to&nbsp;a&nbsp;websocket&nbsp;client"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 139&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;&&nbsp;data]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 140&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[channel&nbsp;(get-client-channel&nbsp;sess-id)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;json-data&nbsp;(json/encode&nbsp;data)]
                </span><br/>
<span class="partial" title="9 out of 18 forms covered">
                 142&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(log/trace&nbsp;"Sending&nbsp;data:"&nbsp;data)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 143&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(fn?&nbsp;channel)&nbsp;;&nbsp;application&nbsp;callback?
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 144&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(channel&nbsp;data)
                </span><br/>
<span class="not-covered" title="0 out of 3 forms covered">
                 145&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;channel
                </span><br/>
<span class="not-covered" title="0 out of 4 forms covered">
                 146&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(httpkit/send!&nbsp;channel&nbsp;json-data)))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 147&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 148&nbsp;&nbsp;(defn&nbsp;send-welcome!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 149&nbsp;&nbsp;&nbsp;&nbsp;"send&nbsp;wamp&nbsp;welcome&nbsp;message&nbsp;format&nbsp;to&nbsp;a&nbsp;websocket&nbsp;client.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 150&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;TYPE_ID_WELCOME&nbsp;,&nbsp;sessionId&nbsp;,&nbsp;protocolVersion,&nbsp;serverIdent&nbsp;]"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 151&nbsp;&nbsp;&nbsp;&nbsp;([sess-id]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 152&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send-welcome!&nbsp;sess-id&nbsp;1&nbsp;project-version))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 153&nbsp;&nbsp;&nbsp;&nbsp;([sess-id&nbsp;protocol-ver&nbsp;server-ident]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 154&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send!&nbsp;sess-id&nbsp;TYPE-ID-WELCOME&nbsp;sess-id&nbsp;protocol-ver&nbsp;server-ident)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 155&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 156&nbsp;&nbsp;(defn&nbsp;send-call-result!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 157&nbsp;&nbsp;&nbsp;&nbsp;"send&nbsp;wamp&nbsp;call&nbsp;result&nbsp;message&nbsp;format&nbsp;to&nbsp;a&nbsp;websocket&nbsp;client.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 158&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;TYPE_ID_CALLRESULT&nbsp;,&nbsp;callID&nbsp;,&nbsp;result&nbsp;]"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 159&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;call-id&nbsp;result]
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 160&nbsp;&nbsp;&nbsp;&nbsp;(send!&nbsp;sess-id&nbsp;TYPE-ID-CALLRESULT&nbsp;call-id&nbsp;result))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 161&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 162&nbsp;&nbsp;(defn&nbsp;send-call-error!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 163&nbsp;&nbsp;&nbsp;&nbsp;"send&nbsp;wamp&nbsp;call&nbsp;error&nbsp;message&nbsp;format&nbsp;to&nbsp;a&nbsp;websocket&nbsp;client.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 164&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;TYPE_ID_CALLERROR&nbsp;,&nbsp;callID&nbsp;,&nbsp;errorURI&nbsp;,&nbsp;errorDesc&nbsp;[,&nbsp;errorDetails]&nbsp;]"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 165&nbsp;&nbsp;&nbsp;&nbsp;([sess-id&nbsp;call-id&nbsp;err-uri&nbsp;err-desc]
                </span><br/>
<span class="not-covered" title="0 out of 7 forms covered">
                 166&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send-call-error!&nbsp;sess-id&nbsp;call-id&nbsp;err-uri&nbsp;err-desc&nbsp;nil))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 167&nbsp;&nbsp;&nbsp;&nbsp;([sess-id&nbsp;call-id&nbsp;err-uri&nbsp;err-desc&nbsp;err-details]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 168&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(nil?&nbsp;err-details)
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 169&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send!&nbsp;sess-id&nbsp;TYPE-ID-CALLERROR&nbsp;call-id&nbsp;err-uri&nbsp;err-desc)
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 170&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send!&nbsp;sess-id&nbsp;TYPE-ID-CALLERROR&nbsp;call-id&nbsp;err-uri&nbsp;err-desc&nbsp;err-details))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 171&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 172&nbsp;&nbsp;(defn&nbsp;send-event!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 173&nbsp;&nbsp;&nbsp;&nbsp;"Send&nbsp;an&nbsp;event&nbsp;message&nbsp;to&nbsp;all&nbsp;clients&nbsp;in&nbsp;topic.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 174&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;TYPE_ID_EVENT&nbsp;,&nbsp;topicURI&nbsp;,&nbsp;event&nbsp;]"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 175&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;event]
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 176&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(topic-send!&nbsp;topic&nbsp;TYPE-ID-EVENT&nbsp;topic&nbsp;event))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 177&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 178&nbsp;&nbsp;(defn&nbsp;broadcast-event!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 179&nbsp;&nbsp;&nbsp;&nbsp;"Send&nbsp;an&nbsp;event&nbsp;message&nbsp;to&nbsp;all&nbsp;clients&nbsp;in&nbsp;a&nbsp;topic&nbsp;but&nbsp;those&nbsp;excluded"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 180&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;event&nbsp;excludes]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 181&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(topic-broadcast!&nbsp;topic&nbsp;excludes&nbsp;TYPE-ID-EVENT&nbsp;topic&nbsp;event))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 182&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 183&nbsp;&nbsp;(defn&nbsp;emit-event!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 184&nbsp;&nbsp;&nbsp;&nbsp;"Send&nbsp;an&nbsp;event&nbsp;message&nbsp;to&nbsp;only&nbsp;certain&nbsp;included&nbsp;clients&nbsp;in&nbsp;a&nbsp;topic"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 185&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;event&nbsp;includes]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 186&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(topic-emit!&nbsp;topic&nbsp;includes&nbsp;TYPE-ID-EVENT&nbsp;topic&nbsp;event))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 187&nbsp;&nbsp;
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 188&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 189&nbsp;&nbsp;;;&nbsp;WAMP&nbsp;callbacks
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 190&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 191&nbsp;&nbsp;(defn-&nbsp;callback-rewrite
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 192&nbsp;&nbsp;&nbsp;&nbsp;"utility&nbsp;for&nbsp;rewriting&nbsp;params&nbsp;with&nbsp;an&nbsp;optional&nbsp;callback&nbsp;fn"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 193&nbsp;&nbsp;&nbsp;&nbsp;[callback&nbsp;&&nbsp;params]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 194&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(fn?&nbsp;callback)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 195&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;callback&nbsp;params)
                </span><br/>
<span class="partial" title="12 out of 13 forms covered">
                 196&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(or&nbsp;(nil?&nbsp;callback)&nbsp;(true?&nbsp;callback))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 197&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 198&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 199&nbsp;&nbsp;(defn-&nbsp;on-close
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 200&nbsp;&nbsp;&nbsp;&nbsp;"clean&nbsp;up&nbsp;clients&nbsp;and&nbsp;topics&nbsp;upon&nbsp;disconnect"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 201&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;close-cb&nbsp;unsub-cb]
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 202&nbsp;&nbsp;&nbsp;&nbsp;(fn&nbsp;[status]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 203&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 204&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(fn?&nbsp;close-cb)&nbsp;(close-cb&nbsp;sess-id&nbsp;status))
                </span><br/>
<span class="partial" title="10 out of 11 forms covered">
                 205&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[sess-topics&nbsp;(@client-topics&nbsp;sess-id)]
                </span><br/>
<span class="partial" title="41 out of 61 forms covered">
                 206&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(doseq&nbsp;[[topic&nbsp;_]&nbsp;sess-topics]
                </span><br/>
<span class="partial" title="4 out of 8 forms covered">
                 207&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(topic-unsubscribe&nbsp;topic&nbsp;sess-id)
                </span><br/>
<span class="partial" title="9 out of 18 forms covered">
                 208&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(fn?&nbsp;unsub-cb)&nbsp;(unsub-cb&nbsp;sess-id&nbsp;topic))))
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 209&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(del-client&nbsp;sess-id))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 210&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 211&nbsp;&nbsp;(defn-&nbsp;call-success
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 212&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;result&nbsp;on-after-cb]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 213&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[cb-params&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;result]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 214&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb-params&nbsp;(apply&nbsp;callback-rewrite&nbsp;on-after-cb&nbsp;cb-params)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 215&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;result]&nbsp;cb-params]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 216&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send-call-result!&nbsp;sess-id&nbsp;call-id&nbsp;result)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 217&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 218&nbsp;&nbsp;(defn-&nbsp;call-error
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 219&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;error&nbsp;on-after-cb]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 220&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[cb-params&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;error]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 221&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb-params&nbsp;(apply&nbsp;callback-rewrite&nbsp;on-after-cb&nbsp;cb-params)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 222&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;error]&nbsp;cb-params
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 223&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{err-uri&nbsp;:uri&nbsp;err-msg&nbsp;:message&nbsp;err-desc&nbsp;:description&nbsp;kill&nbsp;:kill}&nbsp;error
                </span><br/>
<span class="partial" title="5 out of 6 forms covered">
                 224&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err-uri&nbsp;(if&nbsp;(nil?&nbsp;err-uri)&nbsp;URI-WAMP-ERROR-GENERIC&nbsp;err-uri)
                </span><br/>
<span class="partial" title="5 out of 6 forms covered">
                 225&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err-msg&nbsp;(if&nbsp;(nil?&nbsp;err-msg)&nbsp;DESC-WAMP-ERROR-GENERIC&nbsp;err-msg)]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 226&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send-call-error!&nbsp;sess-id&nbsp;call-id&nbsp;err-uri&nbsp;err-msg&nbsp;err-desc)
                </span><br/>
<span class="partial" title="2 out of 8 forms covered">
                 227&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;kill&nbsp;(httpkit/close&nbsp;(get-client-channel&nbsp;sess-id)))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 228&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 229&nbsp;&nbsp;;&nbsp;Optional&nbsp;session&nbsp;id&nbsp;for&nbsp;rpc&nbsp;calls
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 230&nbsp;&nbsp;(def&nbsp;^:dynamic&nbsp;*call-sess-id*&nbsp;nil)
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 231&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 232&nbsp;&nbsp;(defn-&nbsp;on-call
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 233&nbsp;&nbsp;&nbsp;&nbsp;"handle&nbsp;client&nbsp;call&nbsp;(RPC)&nbsp;messages"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 234&nbsp;&nbsp;&nbsp;&nbsp;[callbacks&nbsp;sess-id&nbsp;topic&nbsp;call-id&nbsp;&&nbsp;call-params]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 235&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[rpc-cb&nbsp;(callbacks&nbsp;topic)]
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 236&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(try
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 237&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[cb-params&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;call-params]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 238&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb-params&nbsp;(apply&nbsp;callback-rewrite&nbsp;(callbacks&nbsp;:on-before)&nbsp;cb-params)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 239&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;call-params]&nbsp;cb-params
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 240&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rpc-result&nbsp;(binding&nbsp;[*call-sess-id*&nbsp;sess-id]&nbsp;&nbsp;;&nbsp;bind&nbsp;optional&nbsp;sess-id
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 241&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;rpc-cb&nbsp;call-params))&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;use&nbsp;fn's&nbsp;own&nbsp;arg&nbsp;signature
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 242&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(:error&nbsp;&nbsp;rpc-result)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 243&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(:result&nbsp;rpc-result)]
                </span><br/>
<span class="covered" title="11 out of 11 forms covered">
                 244&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(and&nbsp;(nil?&nbsp;error)&nbsp;(nil?&nbsp;result))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 245&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;No&nbsp;map&nbsp;with&nbsp;result&nbsp;or&nbsp;error?&nbsp;Assume&nbsp;successful&nbsp;rpc-result&nbsp;as-is
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 246&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(call-success&nbsp;sess-id&nbsp;topic&nbsp;call-id&nbsp;rpc-result&nbsp;(callbacks&nbsp;:on-after-success))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 247&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(nil?&nbsp;error)
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 248&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(call-success&nbsp;sess-id&nbsp;topic&nbsp;call-id&nbsp;result&nbsp;(callbacks&nbsp;:on-after-success))
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 249&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(call-error&nbsp;&nbsp;&nbsp;sess-id&nbsp;topic&nbsp;call-id&nbsp;error&nbsp;&nbsp;(callbacks&nbsp;:on-after-error)))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 250&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 251&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(catch&nbsp;Exception&nbsp;e
                </span><br/>
<span class="covered" title="11 out of 11 forms covered">
                 252&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(call-error&nbsp;sess-id&nbsp;topic&nbsp;call-id
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 253&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:uri&nbsp;URI-WAMP-ERROR-INTERNAL
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 254&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:message&nbsp;DESC-WAMP-ERROR-INTERNAL
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 255&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:description&nbsp;(.getMessage&nbsp;e)}
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 256&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(callbacks&nbsp;:on-after-error))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 257&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 258&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(call-error&nbsp;sess-id&nbsp;topic&nbsp;call-id
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 259&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:uri&nbsp;URI-WAMP-ERROR-NOTFOUND
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 260&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:message&nbsp;DESC-WAMP-ERROR-NOTFOUND}
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 261&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(callbacks&nbsp;:on-after-error))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 262&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 263&nbsp;&nbsp;(defn-&nbsp;map-key-or-prefix
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 264&nbsp;&nbsp;&nbsp;&nbsp;"finds&nbsp;a&nbsp;map&nbsp;value&nbsp;by&nbsp;key&nbsp;or&nbsp;string&nbsp;key&nbsp;prefix&nbsp;(ending&nbsp;with&nbsp;*)"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 265&nbsp;&nbsp;&nbsp;&nbsp;[m&nbsp;k]
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 266&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[v&nbsp;(m&nbsp;k)]&nbsp;v
                </span><br/>
<span class="covered" title="11 out of 11 forms covered">
                 267&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(some&nbsp;#(when&nbsp;(not&nbsp;(nil?&nbsp;%))&nbsp;%)
                </span><br/>
<span class="partial" title="43 out of 100 forms covered">
                 268&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(for&nbsp;[[mk&nbsp;mv]&nbsp;m]
                </span><br/>
<span class="partial" title="25 out of 52 forms covered">
                 269&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(and&nbsp;(not&nbsp;(keyword?&nbsp;mk))&nbsp;(not&nbsp;(false?&nbsp;mv))
                </span><br/>
<span class="partial" title="6 out of 12 forms covered">
                 270&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(=&nbsp;\*&nbsp;(last&nbsp;mk))
                </span><br/>
<span class="partial" title="12 out of 24 forms covered">
                 271&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(=&nbsp;(take&nbsp;(dec&nbsp;(count&nbsp;mk))&nbsp;k)&nbsp;(butlast&nbsp;mk)))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 272&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mv)))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 273&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 274&nbsp;&nbsp;(defn-&nbsp;on-subscribe
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 275&nbsp;&nbsp;&nbsp;&nbsp;[callbacks&nbsp;sess-id&nbsp;topic]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 276&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="12 out of 12 forms covered">
                 277&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(nil?&nbsp;(get-in&nbsp;@topic-clients&nbsp;[topic&nbsp;sess-id]))
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 278&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when-let&nbsp;[topic-cb&nbsp;(map-key-or-prefix&nbsp;callbacks&nbsp;topic)]
                </span><br/>
<span class="covered" title="13 out of 13 forms covered">
                 279&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(or&nbsp;(true?&nbsp;topic-cb)&nbsp;(topic-cb&nbsp;sess-id&nbsp;topic))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 280&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[on-after-cb&nbsp;(callbacks&nbsp;:on-after)]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 281&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(topic-subscribe&nbsp;topic&nbsp;sess-id)
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 282&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(fn?&nbsp;on-after-cb)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 283&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-after-cb&nbsp;sess-id&nbsp;topic))))))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 284&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 285&nbsp;&nbsp;(defn-&nbsp;get-publish-exclude&nbsp;[sess-id&nbsp;exclude]
                </span><br/>
<span class="partial" title="7 out of 8 forms covered">
                 286&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(=&nbsp;Boolean&nbsp;(type&nbsp;exclude))
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 287&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(true?&nbsp;exclude)&nbsp;[sess-id])
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 288&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exclude))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 289&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 290&nbsp;&nbsp;(defn-&nbsp;on-publish
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 291&nbsp;&nbsp;&nbsp;&nbsp;"handle&nbsp;client&nbsp;publish&nbsp;messages,
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 292&nbsp;&nbsp;&nbsp;&nbsp;sending&nbsp;events&nbsp;to&nbsp;clients&nbsp;subscribed&nbsp;to&nbsp;the&nbsp;topic.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 293&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;TYPE_ID_PUBLISH&nbsp;,&nbsp;topicURI&nbsp;,&nbsp;event&nbsp;[,&nbsp;exclude&nbsp;[,&nbsp;eligible&nbsp;]]"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 294&nbsp;&nbsp;&nbsp;&nbsp;([callbacks&nbsp;sess-id&nbsp;topic&nbsp;event]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 295&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-publish&nbsp;callbacks&nbsp;sess-id&nbsp;topic&nbsp;event&nbsp;false&nbsp;nil))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 296&nbsp;&nbsp;&nbsp;&nbsp;([callbacks&nbsp;sess-id&nbsp;topic&nbsp;event&nbsp;exclude]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 297&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-publish&nbsp;callbacks&nbsp;sess-id&nbsp;topic&nbsp;event&nbsp;exclude&nbsp;nil))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 298&nbsp;&nbsp;&nbsp;&nbsp;([callbacks&nbsp;sess-id&nbsp;topic&nbsp;event&nbsp;exclude&nbsp;eligible]
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 299&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when-let&nbsp;[pub-cb&nbsp;(map-key-or-prefix&nbsp;callbacks&nbsp;topic)]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 300&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[cb-params&nbsp;[sess-id&nbsp;topic&nbsp;event&nbsp;exclude&nbsp;eligible]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 301&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb-params&nbsp;(apply&nbsp;callback-rewrite&nbsp;pub-cb&nbsp;cb-params)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 302&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-after-cb&nbsp;(callbacks&nbsp;:on-after)]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 303&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(sequential?&nbsp;cb-params)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 304&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[[sess-id&nbsp;topic&nbsp;event&nbsp;exclude&nbsp;eligible]&nbsp;cb-params
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 305&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exclude&nbsp;(get-publish-exclude&nbsp;sess-id&nbsp;exclude)]
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 306&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if-not&nbsp;(nil?&nbsp;eligible)
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 307&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(emit-event!&nbsp;topic&nbsp;event&nbsp;eligible)
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 308&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(broadcast-event!&nbsp;topic&nbsp;event&nbsp;exclude))
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 309&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(fn?&nbsp;on-after-cb)
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 310&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-after-cb&nbsp;sess-id&nbsp;topic&nbsp;event&nbsp;exclude&nbsp;eligible))))))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 311&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 312&nbsp;&nbsp;(defn-&nbsp;on-message
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 313&nbsp;&nbsp;&nbsp;&nbsp;"handle&nbsp;all&nbsp;http-kit&nbsp;messages.&nbsp;parses&nbsp;the&nbsp;incoming&nbsp;data&nbsp;as&nbsp;json
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 314&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;finds&nbsp;the&nbsp;appropriate&nbsp;wamp&nbsp;callback."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 315&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;callbacks]
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 316&nbsp;&nbsp;&nbsp;&nbsp;(fn&nbsp;[data]
                </span><br/>
<span class="partial" title="9 out of 18 forms covered">
                 317&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(log/trace&nbsp;"Data&nbsp;received:"&nbsp;data)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 318&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[[msg-type&nbsp;&&nbsp;msg-params]&nbsp;(json/decode&nbsp;data)&nbsp;;&nbsp;TODO&nbsp;parse&nbsp;error&nbsp;handling
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 319&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-call-cbs&nbsp;&nbsp;(callbacks&nbsp;:on-call)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 320&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-sub-cbs&nbsp;&nbsp;&nbsp;(callbacks&nbsp;:on-subscribe)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 321&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-unsub-cb&nbsp;&nbsp;(callbacks&nbsp;:on-unsubscribe)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 322&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-pub-cbs&nbsp;&nbsp;&nbsp;(callbacks&nbsp;:on-publish)]
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 323&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(case&nbsp;msg-type
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 324&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 325&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;;TYPE-ID-PREFIX
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 326&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;add-prefix&nbsp;sess-id&nbsp;msg-params)
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 327&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 328&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;;TYPE-ID-CALL
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 329&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(map?&nbsp;on-call-cbs)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 330&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[[call-id&nbsp;topic-uri&nbsp;&&nbsp;call-params]&nbsp;msg-params
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 331&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topic&nbsp;(get-topic&nbsp;sess-id&nbsp;topic-uri)]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 332&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;on-call&nbsp;on-call-cbs&nbsp;sess-id&nbsp;topic&nbsp;call-id&nbsp;call-params)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 333&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 334&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;;TYPE-ID-SUBSCRIBE
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 335&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[topic&nbsp;(get-topic&nbsp;sess-id&nbsp;(first&nbsp;msg-params))]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 336&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-subscribe&nbsp;on-sub-cbs&nbsp;sess-id&nbsp;topic))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 337&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 338&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6&nbsp;;TYPE-ID-UNSUBSCRIBE
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 339&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[topic&nbsp;(get-topic&nbsp;sess-id&nbsp;(first&nbsp;msg-params))]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 340&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="12 out of 12 forms covered">
                 341&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(true?&nbsp;(get-in&nbsp;@topic-clients&nbsp;[topic&nbsp;sess-id]))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 342&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(topic-unsubscribe&nbsp;topic&nbsp;sess-id)
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 343&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(fn?&nbsp;on-unsub-cb)&nbsp;(on-unsub-cb&nbsp;sess-id&nbsp;topic)))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 344&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 345&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7&nbsp;;TYPE-ID-PUBLISH
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 346&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[[topic-uri&nbsp;event&nbsp;&&nbsp;pub-args]&nbsp;msg-params
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 347&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topic&nbsp;(get-topic&nbsp;sess-id&nbsp;topic-uri)]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 348&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;on-publish&nbsp;on-pub-cbs&nbsp;sess-id&nbsp;topic&nbsp;event&nbsp;pub-args))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 349&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 350&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;default:&nbsp;Unknown&nbsp;message&nbsp;type
                </span><br/>
<span class="not-covered" title="0 out of 18 forms covered">
                 351&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(log/warn&nbsp;"Unknown&nbsp;message&nbsp;type"&nbsp;data)))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 352&nbsp;&nbsp;
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 353&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 354&nbsp;&nbsp;(defn&nbsp;http-kit-handler
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 355&nbsp;&nbsp;&nbsp;&nbsp;"sets&nbsp;up&nbsp;the&nbsp;necessary&nbsp;http-kit&nbsp;websocket&nbsp;event&nbsp;handlers
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 356&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;use&nbsp;with&nbsp;the&nbsp;wamp&nbsp;sub-protocol"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 357&nbsp;&nbsp;&nbsp;&nbsp;[channel&nbsp;callbacks]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 358&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[cb-on-open&nbsp;&nbsp;(callbacks&nbsp;:on-open)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 359&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sess-id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(add-client&nbsp;channel)]
                </span><br/>
<span class="covered" title="12 out of 12 forms covered">
                 360&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(httpkit/on-close&nbsp;channel&nbsp;(on-close&nbsp;sess-id&nbsp;(callbacks&nbsp;:on-close)&nbsp;(callbacks&nbsp;:on-unsubscribe)))
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 361&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(httpkit/on-receive&nbsp;channel&nbsp;(on-message&nbsp;sess-id&nbsp;callbacks))
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 362&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send-welcome!&nbsp;sess-id)
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 363&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(fn?&nbsp;cb-on-open)&nbsp;(cb-on-open&nbsp;sess-id))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 364&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sess-id))
                </span><br/>
 </body>
</html>
