<html>
 <head>
  <link rel="stylesheet" href="../coverage.css"/>  <title> clj_wamp/server.clj </title>
 </head>
 <body>
<span class="covered" title="37 out of 37 forms covered">
                 001&nbsp;&nbsp;(ns&nbsp;clj-wamp.server
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 002&nbsp;&nbsp;&nbsp;&nbsp;^{:author&nbsp;"Christopher&nbsp;Martin"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 003&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:doc&nbsp;"Clojure&nbsp;implementation&nbsp;of&nbsp;the&nbsp;WebSocket&nbsp;Application&nbsp;Messaging&nbsp;Protocol"}
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 004&nbsp;&nbsp;&nbsp;&nbsp;(:use&nbsp;[clojure.core.incubator&nbsp;:only&nbsp;[dissoc-in]]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 005&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[clojure.string&nbsp;:only&nbsp;[split&nbsp;trim&nbsp;lower-case]])
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 006&nbsp;&nbsp;&nbsp;&nbsp;(:require&nbsp;[clojure.java.io&nbsp;:as&nbsp;io]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 007&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[org.httpkit.server&nbsp;:as&nbsp;httpkit]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 008&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[org.httpkit.timer&nbsp;:as&nbsp;timer]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 009&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[cheshire.core&nbsp;:as&nbsp;json]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 010&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[clojure.tools.logging&nbsp;:as&nbsp;log]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 011&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[clojure.data.codec.base64&nbsp;:as&nbsp;base64])
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 012&nbsp;&nbsp;&nbsp;&nbsp;(:import&nbsp;[org.httpkit.server&nbsp;AsyncChannel]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 013&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[javax.crypto&nbsp;Mac]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 014&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[javax.crypto.spec&nbsp;SecretKeySpec]))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 015&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 016&nbsp;&nbsp;(declare&nbsp;send!)
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 017&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 018&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-WELCOME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0)&nbsp;;&nbsp;Server-to-client&nbsp;(Aux)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 019&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-PREFIX&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1)&nbsp;;&nbsp;Client-to-server&nbsp;(Aux)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 020&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-CALL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2)&nbsp;;&nbsp;Client-to-server&nbsp;(RPC)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 021&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-CALLRESULT&nbsp;&nbsp;3)&nbsp;;&nbsp;Server-to-client&nbsp;(RPC)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 022&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-CALLERROR&nbsp;&nbsp;&nbsp;4)&nbsp;;&nbsp;Server-to-client&nbsp;(RPC)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 023&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-SUBSCRIBE&nbsp;&nbsp;&nbsp;5)&nbsp;;&nbsp;Client-to-server&nbsp;(PubSub)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 024&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-UNSUBSCRIBE&nbsp;6)&nbsp;;&nbsp;Client-to-server&nbsp;(PubSub)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 025&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-PUBLISH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7)&nbsp;;&nbsp;Client-to-server&nbsp;(PubSub)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 026&nbsp;&nbsp;(def&nbsp;^:const&nbsp;TYPE-ID-EVENT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8)&nbsp;;&nbsp;Server-to-client&nbsp;(PubSub)
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 027&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 028&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-BASE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"http://api.wamp.ws/")
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 029&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-ERROR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(str&nbsp;URI-WAMP-BASE&nbsp;"error#"))
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 030&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-PROCEDURE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(str&nbsp;URI-WAMP-BASE&nbsp;"procedure#"))
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 031&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-CALL-AUTHREQ&nbsp;&nbsp;&nbsp;&nbsp;(str&nbsp;URI-WAMP-PROCEDURE&nbsp;"authreq"))
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 032&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-CALL-AUTH&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(str&nbsp;URI-WAMP-PROCEDURE&nbsp;"auth"))
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 033&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-TOPIC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(str&nbsp;URI-WAMP-BASE&nbsp;"topic#"))
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 034&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-ERROR-GENERIC&nbsp;&nbsp;&nbsp;(str&nbsp;URI-WAMP-ERROR&nbsp;"generic"))
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 035&nbsp;&nbsp;(def&nbsp;^:const&nbsp;DESC-WAMP-ERROR-GENERIC&nbsp;&nbsp;"generic&nbsp;error")
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 036&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-ERROR-INTERNAL&nbsp;&nbsp;(str&nbsp;URI-WAMP-ERROR&nbsp;"internal"))
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 037&nbsp;&nbsp;(def&nbsp;^:const&nbsp;DESC-WAMP-ERROR-INTERNAL&nbsp;"internal&nbsp;error")
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 038&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-ERROR-NOTFOUND&nbsp;&nbsp;(str&nbsp;URI-WAMP-ERROR&nbsp;"notfound"))
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 039&nbsp;&nbsp;(def&nbsp;^:const&nbsp;DESC-WAMP-ERROR-NOTFOUND&nbsp;"not&nbsp;found&nbsp;error")
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 040&nbsp;&nbsp;(def&nbsp;^:const&nbsp;DESC-WAMP-ERROR-NOAUTH&nbsp;&nbsp;&nbsp;"unauthorized")
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 041&nbsp;&nbsp;(def&nbsp;^:const&nbsp;URI-WAMP-ERROR-NOAUTH&nbsp;&nbsp;&nbsp;&nbsp;(str&nbsp;URI-WAMP-ERROR&nbsp;"unauthorized"))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 042&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 043&nbsp;&nbsp;(def&nbsp;project-version&nbsp;"clj-wamp/1.0.0-rc1")
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 044&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 045&nbsp;&nbsp;(def&nbsp;max-sess-id&nbsp;(atom&nbsp;0))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 046&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 047&nbsp;&nbsp;(defn-&nbsp;next-sess-id&nbsp;[]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 048&nbsp;&nbsp;&nbsp;&nbsp;(swap!&nbsp;max-sess-id&nbsp;inc))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 049&nbsp;&nbsp;
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 050&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 051&nbsp;&nbsp;;;&nbsp;Client&nbsp;utils
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 052&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 053&nbsp;&nbsp;(def&nbsp;client-channels&nbsp;(ref&nbsp;{}))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 054&nbsp;&nbsp;(def&nbsp;client-prefixes&nbsp;(ref&nbsp;{}))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 055&nbsp;&nbsp;(def&nbsp;client-auth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(ref&nbsp;{}))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 056&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 057&nbsp;&nbsp;(defn&nbsp;add-client
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 058&nbsp;&nbsp;&nbsp;&nbsp;"Adds&nbsp;a&nbsp;websocket&nbsp;channel&nbsp;(or&nbsp;callback&nbsp;function)&nbsp;to&nbsp;a&nbsp;map&nbsp;of&nbsp;clients
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 059&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;returns&nbsp;a&nbsp;unique&nbsp;session&nbsp;id."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 060&nbsp;&nbsp;&nbsp;&nbsp;[channel-or-fn]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 061&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[sess-id&nbsp;(str&nbsp;(System/currentTimeMillis)&nbsp;"-"&nbsp;(next-sess-id))]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 062&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync&nbsp;(alter&nbsp;client-channels&nbsp;assoc&nbsp;sess-id&nbsp;channel-or-fn))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 063&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sess-id))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 064&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 065&nbsp;&nbsp;(defn&nbsp;get-client-channel
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 066&nbsp;&nbsp;&nbsp;&nbsp;"Returns&nbsp;the&nbsp;channel&nbsp;(or&nbsp;callback&nbsp;function)&nbsp;for&nbsp;a&nbsp;websocket&nbsp;client's
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 067&nbsp;&nbsp;&nbsp;&nbsp;session&nbsp;id."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 068&nbsp;&nbsp;&nbsp;&nbsp;[sess-id]
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 069&nbsp;&nbsp;&nbsp;&nbsp;(get&nbsp;@client-channels&nbsp;sess-id))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 070&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 071&nbsp;&nbsp;(defn&nbsp;del-client
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 072&nbsp;&nbsp;&nbsp;&nbsp;"Removes&nbsp;a&nbsp;websocket&nbsp;session&nbsp;from&nbsp;the&nbsp;map&nbsp;of&nbsp;clients."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 073&nbsp;&nbsp;&nbsp;&nbsp;[sess-id]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 074&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 075&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;client-channels&nbsp;dissoc&nbsp;sess-id)
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 076&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;client-prefixes&nbsp;dissoc&nbsp;sess-id)
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 077&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;client-auth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dissoc&nbsp;sess-id)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 078&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 079&nbsp;&nbsp;(defn&nbsp;add-topic-prefix
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 080&nbsp;&nbsp;&nbsp;&nbsp;"Adds&nbsp;a&nbsp;new&nbsp;CURI&nbsp;topic&nbsp;prefix&nbsp;for&nbsp;a&nbsp;websocket&nbsp;client."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 081&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;prefix&nbsp;uri]
                </span><br/>
<span class="covered" title="21 out of 21 forms covered">
                 082&nbsp;&nbsp;&nbsp;&nbsp;(log/trace&nbsp;"New&nbsp;CURI&nbsp;Prefix&nbsp;["&nbsp;sess-id&nbsp;"]"&nbsp;prefix&nbsp;uri)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 083&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 084&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;client-prefixes&nbsp;assoc-in&nbsp;[sess-id&nbsp;prefix]&nbsp;uri)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 085&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 086&nbsp;&nbsp;(defn&nbsp;get-topic
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 087&nbsp;&nbsp;&nbsp;&nbsp;"Returns&nbsp;the&nbsp;full&nbsp;topic&nbsp;URI&nbsp;for&nbsp;a&nbsp;prefix.&nbsp;If&nbsp;prefix&nbsp;does&nbsp;not&nbsp;exist,
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 088&nbsp;&nbsp;&nbsp;&nbsp;returns&nbsp;the&nbsp;CURI&nbsp;passed&nbsp;in."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 089&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;curi]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 090&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[topic&nbsp;(split&nbsp;curi&nbsp;#":")
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 091&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prefix&nbsp;(first&nbsp;topic)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 092&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;suffix&nbsp;(second&nbsp;topic)]
                </span><br/>
<span class="covered" title="14 out of 14 forms covered">
                 093&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[uri&nbsp;(get-in&nbsp;@client-prefixes&nbsp;[sess-id&nbsp;prefix])]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 094&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(str&nbsp;uri&nbsp;suffix)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 095&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;curi)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 096&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 097&nbsp;&nbsp;(defn&nbsp;close-channel
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 098&nbsp;&nbsp;&nbsp;&nbsp;([sess-id]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 099&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(close-channel&nbsp;sess-id&nbsp;1002))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 100&nbsp;&nbsp;&nbsp;&nbsp;([sess-id&nbsp;code]
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 101&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when-let&nbsp;[channel&nbsp;(get-client-channel&nbsp;sess-id)]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 102&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(fn?&nbsp;channel)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 103&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(httpkit/close&nbsp;channel)&nbsp;;&nbsp;for&nbsp;unit&nbsp;testing
                </span><br/>
<span class="not-covered" title="0 out of 2 forms covered">
                 104&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(.serverClose&nbsp;channel&nbsp;code))&nbsp;;&nbsp;TODO&nbsp;thread-safe?&nbsp;(locking&nbsp;AsyncChannel&nbsp;...)&nbsp;?
                </span><br/>
<span class="covered" title="18 out of 18 forms covered">
                 105&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(log/trace&nbsp;"Channel&nbsp;closed"&nbsp;code))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 106&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 107&nbsp;&nbsp;;;&nbsp;Topic&nbsp;utils
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 108&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 109&nbsp;&nbsp;(def&nbsp;client-topics&nbsp;(ref&nbsp;{}))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 110&nbsp;&nbsp;(def&nbsp;topic-clients&nbsp;(ref&nbsp;{}))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 111&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 112&nbsp;&nbsp;(defn&nbsp;topic-subscribe
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 113&nbsp;&nbsp;&nbsp;&nbsp;"Subscribes&nbsp;a&nbsp;websocket&nbsp;session&nbsp;to&nbsp;a&nbsp;topic."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 114&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;sess-id]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 115&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 116&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;topic-clients&nbsp;assoc-in&nbsp;[topic&nbsp;sess-id]&nbsp;true)
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 117&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;client-topics&nbsp;assoc-in&nbsp;[sess-id&nbsp;topic]&nbsp;true)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 118&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 119&nbsp;&nbsp;(defn&nbsp;topic-unsubscribe
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 120&nbsp;&nbsp;&nbsp;&nbsp;"Unsubscribes&nbsp;a&nbsp;websocket&nbsp;session&nbsp;from&nbsp;a&nbsp;topic."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 121&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;sess-id]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 122&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 123&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;topic-clients&nbsp;dissoc-in&nbsp;[topic&nbsp;sess-id])
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 124&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;client-topics&nbsp;dissoc-in&nbsp;[sess-id&nbsp;topic])))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 125&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 126&nbsp;&nbsp;(defn-&nbsp;topic-send!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 127&nbsp;&nbsp;&nbsp;&nbsp;"Sends&nbsp;an&nbsp;event&nbsp;to&nbsp;*all*&nbsp;websocket&nbsp;clients&nbsp;subscribed&nbsp;to&nbsp;a&nbsp;topic."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 128&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;&&nbsp;data]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 129&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="partial" title="45 out of 65 forms covered">
                 130&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(doseq&nbsp;[[sess-id&nbsp;_]&nbsp;(@topic-clients&nbsp;topic)]
                </span><br/>
<span class="partial" title="5 out of 10 forms covered">
                 131&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;send!&nbsp;sess-id&nbsp;data))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 132&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 133&nbsp;&nbsp;(defn-&nbsp;topic-broadcast!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 134&nbsp;&nbsp;&nbsp;&nbsp;"Send&nbsp;an&nbsp;event&nbsp;to&nbsp;websocket&nbsp;clients&nbsp;subscribed&nbsp;to&nbsp;a&nbsp;topic,
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 135&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;those&nbsp;excluded."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 136&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;excludes&nbsp;&&nbsp;data]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 137&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[excludes&nbsp;(if&nbsp;(sequential?&nbsp;excludes)&nbsp;excludes&nbsp;[excludes])]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 138&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="partial" title="45 out of 65 forms covered">
                 139&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(doseq&nbsp;[[sess-id&nbsp;_]&nbsp;(@topic-clients&nbsp;topic)]
                </span><br/>
<span class="partial" title="6 out of 12 forms covered">
                 140&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(not-any?&nbsp;#{sess-id}&nbsp;excludes)
                </span><br/>
<span class="partial" title="5 out of 10 forms covered">
                 141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;send!&nbsp;sess-id&nbsp;data))))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 142&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 143&nbsp;&nbsp;(defn-&nbsp;topic-emit!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 144&nbsp;&nbsp;&nbsp;&nbsp;"Sends&nbsp;an&nbsp;event&nbsp;to&nbsp;a&nbsp;specific&nbsp;list&nbsp;of&nbsp;websocket&nbsp;clients&nbsp;subscribed
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 145&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;a&nbsp;topic."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 146&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;includes&nbsp;&&nbsp;data]
                </span><br/>
<span class="partial" title="6 out of 8 forms covered">
                 147&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[includes&nbsp;(if&nbsp;(sequential?&nbsp;includes)&nbsp;includes&nbsp;[includes])]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 148&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="partial" title="45 out of 65 forms covered">
                 149&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(doseq&nbsp;[[sess-id&nbsp;_]&nbsp;(@topic-clients&nbsp;topic)]
                </span><br/>
<span class="partial" title="6 out of 12 forms covered">
                 150&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(some&nbsp;#{sess-id}&nbsp;includes)
                </span><br/>
<span class="partial" title="5 out of 10 forms covered">
                 151&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;send!&nbsp;sess-id&nbsp;data))))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 152&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 153&nbsp;&nbsp;(defn&nbsp;get-topic-clients&nbsp;[topic]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 154&nbsp;&nbsp;&nbsp;&nbsp;"Returns&nbsp;all&nbsp;client&nbsp;session&nbsp;ids&nbsp;within&nbsp;a&nbsp;topic."
                </span><br/>
<span class="partial" title="10 out of 11 forms covered">
                 155&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[clients&nbsp;(@topic-clients&nbsp;topic)]
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 156&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(keys&nbsp;clients)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 157&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 158&nbsp;&nbsp;;;&nbsp;WAMP&nbsp;websocket&nbsp;send!&nbsp;utils
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 159&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 160&nbsp;&nbsp;(defn-&nbsp;send!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 161&nbsp;&nbsp;&nbsp;&nbsp;"Sends&nbsp;data&nbsp;to&nbsp;a&nbsp;websocket&nbsp;client."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 162&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;&&nbsp;data]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 163&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 164&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[channel-or-fn&nbsp;(get-client-channel&nbsp;sess-id)
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 165&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;json-data&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(json/encode&nbsp;data&nbsp;{:escape-non-ascii&nbsp;true})]
                </span><br/>
<span class="covered" title="18 out of 18 forms covered">
                 166&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(log/trace&nbsp;"Sending&nbsp;data:"&nbsp;data)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 167&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(fn?&nbsp;channel-or-fn)&nbsp;;&nbsp;application&nbsp;callback?
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 168&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(channel-or-fn&nbsp;data)
                </span><br/>
<span class="not-covered" title="0 out of 3 forms covered">
                 169&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;channel-or-fn
                </span><br/>
<span class="not-covered" title="0 out of 4 forms covered">
                 170&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(httpkit/send!&nbsp;channel-or-fn&nbsp;json-data))))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 171&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 172&nbsp;&nbsp;(defn&nbsp;send-welcome!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 173&nbsp;&nbsp;&nbsp;&nbsp;"Sends&nbsp;a&nbsp;WAMP&nbsp;welcome&nbsp;message&nbsp;to&nbsp;a&nbsp;websocket&nbsp;client.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 174&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;TYPE_ID_WELCOME&nbsp;,&nbsp;sessionId&nbsp;,&nbsp;protocolVersion,&nbsp;serverIdent&nbsp;]"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 175&nbsp;&nbsp;&nbsp;&nbsp;([sess-id]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 176&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send-welcome!&nbsp;sess-id&nbsp;1&nbsp;project-version))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 177&nbsp;&nbsp;&nbsp;&nbsp;([sess-id&nbsp;protocol-ver&nbsp;server-ident]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 178&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send!&nbsp;sess-id&nbsp;TYPE-ID-WELCOME&nbsp;sess-id&nbsp;protocol-ver&nbsp;server-ident)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 179&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 180&nbsp;&nbsp;(defn&nbsp;send-call-result!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 181&nbsp;&nbsp;&nbsp;&nbsp;"Sends&nbsp;a&nbsp;WAMP&nbsp;call&nbsp;result&nbsp;message&nbsp;to&nbsp;a&nbsp;websocket&nbsp;client.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 182&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;TYPE_ID_CALLRESULT&nbsp;,&nbsp;callID&nbsp;,&nbsp;result&nbsp;]"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 183&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;call-id&nbsp;result]
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 184&nbsp;&nbsp;&nbsp;&nbsp;(send!&nbsp;sess-id&nbsp;TYPE-ID-CALLRESULT&nbsp;call-id&nbsp;result))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 185&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 186&nbsp;&nbsp;(defn&nbsp;send-call-error!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 187&nbsp;&nbsp;&nbsp;&nbsp;"Sends&nbsp;a&nbsp;WAMP&nbsp;call&nbsp;error&nbsp;message&nbsp;to&nbsp;a&nbsp;websocket&nbsp;client.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 188&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;TYPE_ID_CALLERROR&nbsp;,&nbsp;callID&nbsp;,&nbsp;errorURI&nbsp;,&nbsp;errorDesc&nbsp;[,&nbsp;errorDetails]&nbsp;]"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 189&nbsp;&nbsp;&nbsp;&nbsp;([sess-id&nbsp;call-id&nbsp;err-uri&nbsp;err-desc]
                </span><br/>
<span class="not-covered" title="0 out of 7 forms covered">
                 190&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send-call-error!&nbsp;sess-id&nbsp;call-id&nbsp;err-uri&nbsp;err-desc&nbsp;nil))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 191&nbsp;&nbsp;&nbsp;&nbsp;([sess-id&nbsp;call-id&nbsp;err-uri&nbsp;err-desc&nbsp;err-details]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 192&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(nil?&nbsp;err-details)
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 193&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send!&nbsp;sess-id&nbsp;TYPE-ID-CALLERROR&nbsp;call-id&nbsp;err-uri&nbsp;err-desc)
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 194&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send!&nbsp;sess-id&nbsp;TYPE-ID-CALLERROR&nbsp;call-id&nbsp;err-uri&nbsp;err-desc&nbsp;err-details))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 195&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 196&nbsp;&nbsp;(defn&nbsp;send-event!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 197&nbsp;&nbsp;&nbsp;&nbsp;"Sends&nbsp;an&nbsp;event&nbsp;message&nbsp;to&nbsp;all&nbsp;clients&nbsp;in&nbsp;topic.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 198&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;TYPE_ID_EVENT&nbsp;,&nbsp;topicURI&nbsp;,&nbsp;event&nbsp;]"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 199&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;event]
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 200&nbsp;&nbsp;&nbsp;&nbsp;(topic-send!&nbsp;topic&nbsp;TYPE-ID-EVENT&nbsp;topic&nbsp;event))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 201&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 202&nbsp;&nbsp;(defn&nbsp;broadcast-event!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 203&nbsp;&nbsp;&nbsp;&nbsp;"Sends&nbsp;an&nbsp;event&nbsp;message&nbsp;to&nbsp;all&nbsp;clients&nbsp;in&nbsp;a&nbsp;topic&nbsp;but&nbsp;those&nbsp;excluded."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 204&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;event&nbsp;excludes]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 205&nbsp;&nbsp;&nbsp;&nbsp;(topic-broadcast!&nbsp;topic&nbsp;excludes&nbsp;TYPE-ID-EVENT&nbsp;topic&nbsp;event))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 206&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 207&nbsp;&nbsp;(defn&nbsp;emit-event!
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 208&nbsp;&nbsp;&nbsp;&nbsp;"Sends&nbsp;an&nbsp;event&nbsp;message&nbsp;to&nbsp;specific&nbsp;clients&nbsp;in&nbsp;a&nbsp;topic"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 209&nbsp;&nbsp;&nbsp;&nbsp;[topic&nbsp;event&nbsp;includes]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 210&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(topic-emit!&nbsp;topic&nbsp;includes&nbsp;TYPE-ID-EVENT&nbsp;topic&nbsp;event))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 211&nbsp;&nbsp;
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 212&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 213&nbsp;&nbsp;;;&nbsp;WAMP&nbsp;callbacks
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 214&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 215&nbsp;&nbsp;(defn-&nbsp;callback-rewrite
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 216&nbsp;&nbsp;&nbsp;&nbsp;"Utility&nbsp;for&nbsp;rewriting&nbsp;params&nbsp;with&nbsp;an&nbsp;optional&nbsp;callback&nbsp;fn."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 217&nbsp;&nbsp;&nbsp;&nbsp;[callback&nbsp;&&nbsp;params]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 218&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(fn?&nbsp;callback)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 219&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;callback&nbsp;params)
                </span><br/>
<span class="covered" title="13 out of 13 forms covered">
                 220&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(or&nbsp;(nil?&nbsp;callback)&nbsp;(true?&nbsp;callback))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 221&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 222&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 223&nbsp;&nbsp;(defn-&nbsp;on-close
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 224&nbsp;&nbsp;&nbsp;&nbsp;"Clean&nbsp;up&nbsp;clients&nbsp;and&nbsp;topics&nbsp;upon&nbsp;disconnect."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 225&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;close-cb&nbsp;unsub-cb]
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 226&nbsp;&nbsp;&nbsp;&nbsp;(fn&nbsp;[status]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 227&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 228&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(fn?&nbsp;close-cb)&nbsp;(close-cb&nbsp;sess-id&nbsp;status))
                </span><br/>
<span class="covered" title="11 out of 11 forms covered">
                 229&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[sess-topics&nbsp;(@client-topics&nbsp;sess-id)]
                </span><br/>
<span class="partial" title="41 out of 61 forms covered">
                 230&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(doseq&nbsp;[[topic&nbsp;_]&nbsp;sess-topics]
                </span><br/>
<span class="partial" title="4 out of 8 forms covered">
                 231&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(topic-unsubscribe&nbsp;topic&nbsp;sess-id)
                </span><br/>
<span class="partial" title="9 out of 18 forms covered">
                 232&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(fn?&nbsp;unsub-cb)&nbsp;(unsub-cb&nbsp;sess-id&nbsp;topic))))
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 233&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(del-client&nbsp;sess-id))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 234&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 235&nbsp;&nbsp;(defn-&nbsp;call-success
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 236&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;result&nbsp;on-after-cb]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 237&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[cb-params&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;result]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 238&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb-params&nbsp;(apply&nbsp;callback-rewrite&nbsp;on-after-cb&nbsp;cb-params)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 239&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;result]&nbsp;cb-params]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 240&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send-call-result!&nbsp;sess-id&nbsp;call-id&nbsp;result)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 241&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 242&nbsp;&nbsp;(defn-&nbsp;call-error
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 243&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;error&nbsp;on-after-cb]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 244&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[cb-params&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;error]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 245&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb-params&nbsp;(apply&nbsp;callback-rewrite&nbsp;on-after-cb&nbsp;cb-params)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 246&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;error]&nbsp;cb-params
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 247&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{err-uri&nbsp;:uri&nbsp;err-msg&nbsp;:message&nbsp;err-desc&nbsp;:description&nbsp;kill&nbsp;:kill}&nbsp;error
                </span><br/>
<span class="partial" title="5 out of 6 forms covered">
                 248&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err-uri&nbsp;(if&nbsp;(nil?&nbsp;err-uri)&nbsp;URI-WAMP-ERROR-GENERIC&nbsp;err-uri)
                </span><br/>
<span class="partial" title="5 out of 6 forms covered">
                 249&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err-msg&nbsp;(if&nbsp;(nil?&nbsp;err-msg)&nbsp;DESC-WAMP-ERROR-GENERIC&nbsp;err-msg)]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 250&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send-call-error!&nbsp;sess-id&nbsp;call-id&nbsp;err-uri&nbsp;err-msg&nbsp;err-desc)
                </span><br/>
<span class="partial" title="2 out of 6 forms covered">
                 251&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;kill&nbsp;(close-channel&nbsp;sess-id))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 252&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 253&nbsp;&nbsp;;&nbsp;Optional&nbsp;session&nbsp;id&nbsp;for&nbsp;rpc&nbsp;calls
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 254&nbsp;&nbsp;(def&nbsp;^:dynamic&nbsp;*call-sess-id*&nbsp;nil)
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 255&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 256&nbsp;&nbsp;;;&nbsp;WAMP-CRA&nbsp;Authentication
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 257&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 258&nbsp;&nbsp;(defn&nbsp;hmac-sha-256
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 259&nbsp;&nbsp;&nbsp;&nbsp;"Generates&nbsp;a&nbsp;HMAC&nbsp;SHA256&nbsp;hash."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 260&nbsp;&nbsp;&nbsp;&nbsp;[^String&nbsp;key&nbsp;^String&nbsp;data]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 261&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[hmac-key&nbsp;(SecretKeySpec.&nbsp;(.getBytes&nbsp;key)&nbsp;"HmacSHA256")
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 262&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hmac&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(doto&nbsp;(Mac/getInstance&nbsp;"HmacSHA256")&nbsp;(.init&nbsp;hmac-key))
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 263&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;&nbsp;&nbsp;(.doFinal&nbsp;hmac&nbsp;(.getBytes&nbsp;data))]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 264&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(String.&nbsp;(base64/encode&nbsp;result)&nbsp;"UTF-8")))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 265&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 266&nbsp;&nbsp;(defn&nbsp;auth-challenge
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 267&nbsp;&nbsp;&nbsp;&nbsp;"Generates&nbsp;a&nbsp;challenge&nbsp;hash&nbsp;used&nbsp;by&nbsp;the&nbsp;client&nbsp;to&nbsp;sign&nbsp;the&nbsp;secret."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 268&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;auth-key&nbsp;auth-secret]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 269&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[hmac-key&nbsp;(str&nbsp;auth-secret&nbsp;"-"&nbsp;(System/currentTimeMillis)&nbsp;"-"&nbsp;sess-id)]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 270&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(hmac-sha-256&nbsp;hmac-key&nbsp;auth-key)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 271&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 272&nbsp;&nbsp;(defn-&nbsp;auth-sig-match?
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 273&nbsp;&nbsp;&nbsp;&nbsp;"Check&nbsp;whether&nbsp;the&nbsp;client&nbsp;signature&nbsp;matches&nbsp;the&nbsp;server's&nbsp;signature."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 274&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;signature]
                </span><br/>
<span class="partial" title="13 out of 14 forms covered">
                 275&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[auth-sig&nbsp;(get-in&nbsp;@client-auth&nbsp;[sess-id&nbsp;:sig])]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 276&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(=&nbsp;signature&nbsp;auth-sig)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 277&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 278&nbsp;&nbsp;(defn-&nbsp;add-client-auth-sig
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 279&nbsp;&nbsp;&nbsp;&nbsp;"Stores&nbsp;the&nbsp;authorization&nbsp;signature&nbsp;on&nbsp;the&nbsp;server-side&nbsp;for&nbsp;later
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 280&nbsp;&nbsp;&nbsp;&nbsp;comparison&nbsp;with&nbsp;the&nbsp;client."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 281&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;auth-key&nbsp;auth-secret&nbsp;challenge]
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 282&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[sig&nbsp;(hmac-sha-256&nbsp;challenge&nbsp;auth-secret)]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 283&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="12 out of 12 forms covered">
                 284&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;client-auth&nbsp;assoc&nbsp;sess-id&nbsp;{:sig&nbsp;&nbsp;&nbsp;sig
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 285&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:key&nbsp;&nbsp;&nbsp;auth-key
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 286&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:auth?&nbsp;false}))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 287&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sig))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 288&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 289&nbsp;&nbsp;(defn-&nbsp;add-client-auth-anon
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 290&nbsp;&nbsp;&nbsp;&nbsp;"Stores&nbsp;anonymous&nbsp;client&nbsp;metadata&nbsp;with&nbsp;the&nbsp;session."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 291&nbsp;&nbsp;&nbsp;&nbsp;[sess-id]
                </span><br/>
<span class="covered" title="12 out of 12 forms covered">
                 292&nbsp;&nbsp;&nbsp;&nbsp;(dosync&nbsp;(alter&nbsp;client-auth&nbsp;assoc&nbsp;sess-id&nbsp;{:key&nbsp;:anon&nbsp;:auth?&nbsp;false})))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 293&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 294&nbsp;&nbsp;(defn&nbsp;client-auth-requested?
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 295&nbsp;&nbsp;&nbsp;&nbsp;"Checks&nbsp;if&nbsp;the&nbsp;authreq&nbsp;call&nbsp;has&nbsp;already&nbsp;occurred."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 296&nbsp;&nbsp;&nbsp;&nbsp;[sess-id]
                </span><br/>
<span class="covered" title="12 out of 12 forms covered">
                 297&nbsp;&nbsp;&nbsp;&nbsp;(not&nbsp;(nil?&nbsp;(get-in&nbsp;@client-auth&nbsp;[sess-id&nbsp;:key]))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 298&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 299&nbsp;&nbsp;(defn&nbsp;client-authenticated?
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 300&nbsp;&nbsp;&nbsp;&nbsp;"Checks&nbsp;if&nbsp;authentication&nbsp;has&nbsp;occurred."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 301&nbsp;&nbsp;&nbsp;&nbsp;[sess-id]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 302&nbsp;&nbsp;&nbsp;&nbsp;(get-in&nbsp;@client-auth&nbsp;[sess-id&nbsp;:auth?]))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 303&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 304&nbsp;&nbsp;(defn&nbsp;authorized?
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 305&nbsp;&nbsp;&nbsp;&nbsp;"Checks&nbsp;if&nbsp;the&nbsp;session&nbsp;is&nbsp;authorized&nbsp;for&nbsp;a&nbsp;message&nbsp;type&nbsp;and&nbsp;topic."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 306&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;type&nbsp;topic&nbsp;perm-cb]
                </span><br/>
<span class="partial" title="13 out of 14 forms covered">
                 307&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[auth-key&nbsp;(get-in&nbsp;@client-auth&nbsp;[sess-id&nbsp;:key])]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 308&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[perms&nbsp;(perm-cb&nbsp;sess-id&nbsp;auth-key)]
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 309&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(get-in&nbsp;perms&nbsp;[type&nbsp;topic]))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 310&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 311&nbsp;&nbsp;(defn-&nbsp;create-call-authreq
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 312&nbsp;&nbsp;&nbsp;&nbsp;"Creates&nbsp;a&nbsp;callback&nbsp;for&nbsp;the&nbsp;authreq&nbsp;RPC&nbsp;call."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 313&nbsp;&nbsp;&nbsp;&nbsp;[allow-anon?&nbsp;secret-cb]
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 314&nbsp;&nbsp;&nbsp;&nbsp;(fn&nbsp;[&&nbsp;[auth-key&nbsp;extra]]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 315&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 316&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(client-authenticated?&nbsp;*call-sess-id*)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 317&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:error&nbsp;{:uri&nbsp;(str&nbsp;URI-WAMP-ERROR&nbsp;"already-authenticated")
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 318&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:message&nbsp;"already&nbsp;authenticated"}}
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 319&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(client-auth-requested?&nbsp;*call-sess-id*)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 320&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:error&nbsp;{:uri&nbsp;(str&nbsp;URI-WAMP-ERROR&nbsp;"authentication-already-requested")
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 321&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:message&nbsp;"authentication&nbsp;request&nbsp;already&nbsp;issued&nbsp;-&nbsp;authentication&nbsp;pending"}}
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 322&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 323&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(nil?&nbsp;auth-key)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 324&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Allow&nbsp;anonymous&nbsp;auth?
                </span><br/>
<span class="partial" title="4 out of 10 forms covered">
                 325&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if-not&nbsp;allow-anon?
                </span><br/>
<span class="not-covered" title="0 out of 4 forms covered">
                 326&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:error&nbsp;{:uri&nbsp;(str&nbsp;URI-WAMP-ERROR&nbsp;"anonymous-auth-forbidden")
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 327&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:message&nbsp;"authentication&nbsp;as&nbsp;anonymous&nbsp;is&nbsp;forbidden"}}
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 328&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(do
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 329&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(add-client-auth-anon&nbsp;*call-sess-id*)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 330&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nil))&nbsp;;&nbsp;return&nbsp;nil
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 331&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Non-anonymous&nbsp;auth
                </span><br/>
<span class="partial" title="10 out of 16 forms covered">
                 332&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[auth-secret&nbsp;(secret-cb&nbsp;*call-sess-id*&nbsp;auth-key&nbsp;extra)]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 333&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[challenge&nbsp;(auth-challenge&nbsp;*call-sess-id*&nbsp;auth-key&nbsp;auth-secret)]
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 334&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(add-client-auth-sig&nbsp;*call-sess-id*&nbsp;auth-key&nbsp;auth-secret&nbsp;challenge)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 335&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;challenge)&nbsp;;&nbsp;return&nbsp;the&nbsp;challenge
                </span><br/>
<span class="not-covered" title="0 out of 4 forms covered">
                 336&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:error&nbsp;{:uri&nbsp;(str&nbsp;URI-WAMP-ERROR&nbsp;"no-such-authkey")
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 337&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:message&nbsp;"authentication&nbsp;key&nbsp;does&nbsp;not&nbsp;exist"}})))))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 338&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 339&nbsp;&nbsp;(defn-&nbsp;create-call-auth
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 340&nbsp;&nbsp;&nbsp;&nbsp;"Creates&nbsp;a&nbsp;callback&nbsp;for&nbsp;the&nbsp;auth&nbsp;RPC&nbsp;call."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 341&nbsp;&nbsp;&nbsp;&nbsp;[perm-cb]
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 342&nbsp;&nbsp;&nbsp;&nbsp;(fn&nbsp;[&&nbsp;[signature]]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 343&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 344&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(client-authenticated?&nbsp;*call-sess-id*)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 345&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:error&nbsp;{:uri&nbsp;(str&nbsp;URI-WAMP-ERROR&nbsp;"already-authenticated")
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 346&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:message&nbsp;"already&nbsp;authenticated"}}
                </span><br/>
<span class="covered" title="12 out of 12 forms covered">
                 347&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(not&nbsp;(client-auth-requested?&nbsp;*call-sess-id*))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 348&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:error&nbsp;{:uri&nbsp;(str&nbsp;URI-WAMP-ERROR&nbsp;"no-authentication-requested")
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 349&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:message&nbsp;"no&nbsp;authentication&nbsp;previously&nbsp;requested"}}
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 350&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[auth-key&nbsp;(get-in&nbsp;@client-auth&nbsp;[*call-sess-id*&nbsp;:key])]
                </span><br/>
<span class="covered" title="13 out of 13 forms covered">
                 351&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(or&nbsp;(=&nbsp;:anon&nbsp;auth-key)&nbsp;(auth-sig-match?&nbsp;*call-sess-id*&nbsp;signature))
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 352&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(do
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 353&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;client-auth&nbsp;assoc-in&nbsp;[*call-sess-id*&nbsp;:auth?]&nbsp;true)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 354&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(perm-cb&nbsp;*call-sess-id*&nbsp;auth-key))
                </span><br/>
<span class="not-covered" title="0 out of 7 forms covered">
                 355&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(do
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 356&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;remove&nbsp;previous&nbsp;auth&nbsp;data,&nbsp;must&nbsp;request&nbsp;and&nbsp;authenticate&nbsp;again
                </span><br/>
<span class="not-covered" title="0 out of 5 forms covered">
                 357&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(alter&nbsp;client-auth&nbsp;dissoc&nbsp;*call-sess-id*)
                </span><br/>
<span class="not-covered" title="0 out of 4 forms covered">
                 358&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:error&nbsp;{:uri&nbsp;(str&nbsp;URI-WAMP-ERROR&nbsp;"invalid-signature")
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 359&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:message&nbsp;"signature&nbsp;for&nbsp;authentication&nbsp;request&nbsp;is&nbsp;invalid"}}))))))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 360&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 361&nbsp;&nbsp;(defn-&nbsp;init-cr-auth
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 362&nbsp;&nbsp;&nbsp;&nbsp;"Initializes&nbsp;the&nbsp;authorization&nbsp;RPC&nbsp;calls&nbsp;(if&nbsp;configured)."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 363&nbsp;&nbsp;&nbsp;&nbsp;[callbacks]
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 364&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[auth-cbs&nbsp;(callbacks&nbsp;:on-auth)]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 365&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[allow-anon?&nbsp;(auth-cbs&nbsp;:allow-anon?)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 366&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;secret-cb&nbsp;&nbsp;&nbsp;(auth-cbs&nbsp;:secret)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 367&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perm-cb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(auth-cbs&nbsp;:permissions)]
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 368&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(merge-with&nbsp;merge&nbsp;callbacks
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 369&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:on-call&nbsp;{URI-WAMP-CALL-AUTHREQ&nbsp;(create-call-authreq&nbsp;allow-anon?&nbsp;secret-cb)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 370&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;URI-WAMP-CALL-AUTH&nbsp;&nbsp;&nbsp;&nbsp;(create-call-auth&nbsp;perm-cb)}}))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 371&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callbacks))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 372&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 373&nbsp;&nbsp;(defn-&nbsp;auth-timeout
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 374&nbsp;&nbsp;&nbsp;&nbsp;"Closes&nbsp;the&nbsp;session&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;not&nbsp;authenticated."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 375&nbsp;&nbsp;&nbsp;&nbsp;[sess-id]
                </span><br/>
<span class="partial" title="5 out of 6 forms covered">
                 376&nbsp;&nbsp;&nbsp;&nbsp;(when-not&nbsp;(client-authenticated?&nbsp;sess-id)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 377&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(close-channel&nbsp;sess-id)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 378&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 379&nbsp;&nbsp;(defn-&nbsp;init-auth-timer
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 380&nbsp;&nbsp;&nbsp;&nbsp;"Starts&nbsp;a&nbsp;timer&nbsp;to&nbsp;ensure&nbsp;authentication,&nbsp;else&nbsp;the&nbsp;session&nbsp;is&nbsp;closed."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 381&nbsp;&nbsp;&nbsp;&nbsp;[callbacks&nbsp;sess-id]
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 382&nbsp;&nbsp;&nbsp;&nbsp;(when-let&nbsp;[auth-cbs&nbsp;(callbacks&nbsp;:on-auth)]
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 383&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[timeout-ms&nbsp;(auth-cbs&nbsp;:timeout&nbsp;20000)
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 384&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(timer/schedule-task&nbsp;timeout-ms&nbsp;(auth-timeout&nbsp;sess-id))]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 385&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;task)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 386&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 387&nbsp;&nbsp;;;&nbsp;WAMP&nbsp;PubSub/RPC&nbsp;callbacks
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 388&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 389&nbsp;&nbsp;(defn-&nbsp;on-call
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 390&nbsp;&nbsp;&nbsp;&nbsp;"Handle&nbsp;WAMP&nbsp;call&nbsp;(RPC)&nbsp;messages"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 391&nbsp;&nbsp;&nbsp;&nbsp;[callbacks&nbsp;sess-id&nbsp;topic&nbsp;call-id&nbsp;&&nbsp;call-params]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 392&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[rpc-cb&nbsp;(callbacks&nbsp;topic)]
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 393&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(try
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 394&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[cb-params&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;call-params]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 395&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb-params&nbsp;(apply&nbsp;callback-rewrite&nbsp;(callbacks&nbsp;:on-before)&nbsp;cb-params)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 396&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;call-params]&nbsp;cb-params
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 397&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rpc-result&nbsp;(binding&nbsp;[*call-sess-id*&nbsp;sess-id]&nbsp;&nbsp;;&nbsp;bind&nbsp;optional&nbsp;sess-id
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 398&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;rpc-cb&nbsp;call-params))&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;use&nbsp;fn's&nbsp;own&nbsp;arg&nbsp;signature
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 399&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(:error&nbsp;&nbsp;rpc-result)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 400&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(:result&nbsp;rpc-result)]
                </span><br/>
<span class="covered" title="11 out of 11 forms covered">
                 401&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(and&nbsp;(nil?&nbsp;error)&nbsp;(nil?&nbsp;result))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 402&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;No&nbsp;map&nbsp;with&nbsp;result&nbsp;or&nbsp;error?&nbsp;Assume&nbsp;successful&nbsp;rpc-result&nbsp;as-is
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 403&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(call-success&nbsp;sess-id&nbsp;topic&nbsp;call-id&nbsp;rpc-result&nbsp;(callbacks&nbsp;:on-after-success))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 404&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(nil?&nbsp;error)
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 405&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(call-success&nbsp;sess-id&nbsp;topic&nbsp;call-id&nbsp;result&nbsp;(callbacks&nbsp;:on-after-success))
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 406&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(call-error&nbsp;&nbsp;&nbsp;sess-id&nbsp;topic&nbsp;call-id&nbsp;error&nbsp;&nbsp;(callbacks&nbsp;:on-after-error)))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 407&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 408&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(catch&nbsp;Exception&nbsp;e
                </span><br/>
<span class="covered" title="11 out of 11 forms covered">
                 409&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(call-error&nbsp;sess-id&nbsp;topic&nbsp;call-id
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 410&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:uri&nbsp;URI-WAMP-ERROR-INTERNAL
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 411&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:message&nbsp;DESC-WAMP-ERROR-INTERNAL
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 412&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:description&nbsp;(.getMessage&nbsp;e)}
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 413&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(callbacks&nbsp;:on-after-error))
                </span><br/>
<span class="covered" title="20 out of 20 forms covered">
                 414&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(log/error&nbsp;"RPC&nbsp;Exception:"&nbsp;topic&nbsp;call-params&nbsp;e)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 415&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 416&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(call-error&nbsp;sess-id&nbsp;topic&nbsp;call-id
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 417&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:uri&nbsp;URI-WAMP-ERROR-NOTFOUND
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 418&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:message&nbsp;DESC-WAMP-ERROR-NOTFOUND}
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 419&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(callbacks&nbsp;:on-after-error))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 420&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 421&nbsp;&nbsp;(defn-&nbsp;map-key-or-prefix
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 422&nbsp;&nbsp;&nbsp;&nbsp;"Finds&nbsp;a&nbsp;map&nbsp;value&nbsp;by&nbsp;key&nbsp;or&nbsp;lookup&nbsp;by&nbsp;string&nbsp;key&nbsp;prefix&nbsp;(ending&nbsp;with&nbsp;*)."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 423&nbsp;&nbsp;&nbsp;&nbsp;[m&nbsp;k]
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 424&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[v&nbsp;(m&nbsp;k)]&nbsp;v
                </span><br/>
<span class="covered" title="11 out of 11 forms covered">
                 425&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(some&nbsp;#(when&nbsp;(not&nbsp;(nil?&nbsp;%))&nbsp;%)
                </span><br/>
<span class="partial" title="43 out of 100 forms covered">
                 426&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(for&nbsp;[[mk&nbsp;mv]&nbsp;m]
                </span><br/>
<span class="partial" title="25 out of 52 forms covered">
                 427&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(and&nbsp;(not&nbsp;(keyword?&nbsp;mk))&nbsp;(not&nbsp;(false?&nbsp;mv))
                </span><br/>
<span class="partial" title="6 out of 12 forms covered">
                 428&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(=&nbsp;\*&nbsp;(last&nbsp;mk))
                </span><br/>
<span class="partial" title="12 out of 24 forms covered">
                 429&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(=&nbsp;(take&nbsp;(dec&nbsp;(count&nbsp;mk))&nbsp;k)&nbsp;(butlast&nbsp;mk)))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 430&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mv)))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 431&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 432&nbsp;&nbsp;(defn-&nbsp;on-subscribe
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 433&nbsp;&nbsp;&nbsp;&nbsp;[callbacks&nbsp;sess-id&nbsp;topic]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 434&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="12 out of 12 forms covered">
                 435&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(nil?&nbsp;(get-in&nbsp;@topic-clients&nbsp;[topic&nbsp;sess-id]))
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 436&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when-let&nbsp;[topic-cb&nbsp;(map-key-or-prefix&nbsp;callbacks&nbsp;topic)]
                </span><br/>
<span class="covered" title="13 out of 13 forms covered">
                 437&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(or&nbsp;(true?&nbsp;topic-cb)&nbsp;(topic-cb&nbsp;sess-id&nbsp;topic))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 438&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[on-after-cb&nbsp;(callbacks&nbsp;:on-after)]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 439&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(topic-subscribe&nbsp;topic&nbsp;sess-id)
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 440&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(fn?&nbsp;on-after-cb)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 441&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-after-cb&nbsp;sess-id&nbsp;topic))))))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 442&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 443&nbsp;&nbsp;(defn-&nbsp;get-publish-exclude&nbsp;[sess-id&nbsp;exclude]
                </span><br/>
<span class="partial" title="7 out of 8 forms covered">
                 444&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(=&nbsp;Boolean&nbsp;(type&nbsp;exclude))
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 445&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(true?&nbsp;exclude)&nbsp;[sess-id])
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 446&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exclude))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 447&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 448&nbsp;&nbsp;(defn-&nbsp;on-publish
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 449&nbsp;&nbsp;&nbsp;&nbsp;"Handles&nbsp;WAMP&nbsp;publish&nbsp;messages,&nbsp;sending&nbsp;event&nbsp;messages&nbsp;back&nbsp;out
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 450&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;clients&nbsp;subscribed&nbsp;to&nbsp;the&nbsp;topic.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 451&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;TYPE_ID_PUBLISH&nbsp;,&nbsp;topicURI&nbsp;,&nbsp;event&nbsp;[,&nbsp;exclude&nbsp;[,&nbsp;eligible&nbsp;]]"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 452&nbsp;&nbsp;&nbsp;&nbsp;([callbacks&nbsp;sess-id&nbsp;topic&nbsp;event]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 453&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-publish&nbsp;callbacks&nbsp;sess-id&nbsp;topic&nbsp;event&nbsp;false&nbsp;nil))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 454&nbsp;&nbsp;&nbsp;&nbsp;([callbacks&nbsp;sess-id&nbsp;topic&nbsp;event&nbsp;exclude]
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 455&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-publish&nbsp;callbacks&nbsp;sess-id&nbsp;topic&nbsp;event&nbsp;exclude&nbsp;nil))
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 456&nbsp;&nbsp;&nbsp;&nbsp;([callbacks&nbsp;sess-id&nbsp;topic&nbsp;event&nbsp;exclude&nbsp;eligible]
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 457&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when-let&nbsp;[pub-cb&nbsp;(map-key-or-prefix&nbsp;callbacks&nbsp;topic)]
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 458&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[cb-params&nbsp;[sess-id&nbsp;topic&nbsp;event&nbsp;exclude&nbsp;eligible]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 459&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb-params&nbsp;(apply&nbsp;callback-rewrite&nbsp;pub-cb&nbsp;cb-params)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 460&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-after-cb&nbsp;(callbacks&nbsp;:on-after)]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 461&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(sequential?&nbsp;cb-params)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 462&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[[sess-id&nbsp;topic&nbsp;event&nbsp;exclude&nbsp;eligible]&nbsp;cb-params
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 463&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exclude&nbsp;(get-publish-exclude&nbsp;sess-id&nbsp;exclude)]
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 464&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if-not&nbsp;(nil?&nbsp;eligible)
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 465&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(emit-event!&nbsp;topic&nbsp;event&nbsp;eligible)
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 466&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(broadcast-event!&nbsp;topic&nbsp;event&nbsp;exclude))
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 467&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(fn?&nbsp;on-after-cb)
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 468&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-after-cb&nbsp;sess-id&nbsp;topic&nbsp;event&nbsp;exclude&nbsp;eligible))))))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 469&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 470&nbsp;&nbsp;(defn-&nbsp;on-message
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 471&nbsp;&nbsp;&nbsp;&nbsp;"Handles&nbsp;all&nbsp;http-kit&nbsp;messages.&nbsp;parses&nbsp;the&nbsp;incoming&nbsp;data&nbsp;as&nbsp;json
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 472&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;finds&nbsp;the&nbsp;appropriate&nbsp;wamp&nbsp;callback."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 473&nbsp;&nbsp;&nbsp;&nbsp;[sess-id&nbsp;callbacks]
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 474&nbsp;&nbsp;&nbsp;&nbsp;(fn&nbsp;[data]
                </span><br/>
<span class="covered" title="18 out of 18 forms covered">
                 475&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(log/trace&nbsp;"Data&nbsp;received:"&nbsp;data)
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 476&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[[msg-type&nbsp;&&nbsp;msg-params]&nbsp;(try&nbsp;(json/decode&nbsp;data)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 477&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(catch&nbsp;com.fasterxml.jackson.core.JsonParseException&nbsp;ex
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 478&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[nil&nbsp;nil]))
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 479&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-call-cbs&nbsp;&nbsp;(callbacks&nbsp;:on-call)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 480&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-sub-cbs&nbsp;&nbsp;&nbsp;(callbacks&nbsp;:on-subscribe)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 481&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-unsub-cb&nbsp;&nbsp;(callbacks&nbsp;:on-unsubscribe)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 482&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-pub-cbs&nbsp;&nbsp;&nbsp;(callbacks&nbsp;:on-publish)
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 483&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perm-cb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(get-in&nbsp;callbacks&nbsp;[:on-auth&nbsp;:permissions])]
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 484&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(case&nbsp;msg-type
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 485&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 486&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;;TYPE-ID-PREFIX
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 487&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;add-topic-prefix&nbsp;sess-id&nbsp;msg-params)
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 488&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 489&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;;TYPE-ID-CALL
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 490&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(map?&nbsp;on-call-cbs)
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 491&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[[call-id&nbsp;topic-uri&nbsp;&&nbsp;call-params]&nbsp;msg-params
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 492&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topic&nbsp;(get-topic&nbsp;sess-id&nbsp;topic-uri)]
                </span><br/>
<span class="covered" title="18 out of 18 forms covered">
                 493&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(or&nbsp;(nil?&nbsp;perm-cb)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 494&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(=&nbsp;URI-WAMP-CALL-AUTHREQ&nbsp;topic)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 495&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(=&nbsp;URI-WAMP-CALL-AUTH&nbsp;topic)
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 496&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(authorized?&nbsp;sess-id&nbsp;:rpc&nbsp;topic&nbsp;perm-cb))
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 497&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;on-call&nbsp;on-call-cbs&nbsp;sess-id&nbsp;topic&nbsp;call-id&nbsp;call-params)
                </span><br/>
<span class="covered" title="10 out of 10 forms covered">
                 498&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(call-error&nbsp;sess-id&nbsp;topic&nbsp;call-id
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 499&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:uri&nbsp;URI-WAMP-ERROR-NOAUTH&nbsp;:message&nbsp;DESC-WAMP-ERROR-NOAUTH}
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 500&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-call-cbs&nbsp;:on-after-error)))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 501&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 502&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;;TYPE-ID-SUBSCRIBE
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 503&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[topic&nbsp;(get-topic&nbsp;sess-id&nbsp;(first&nbsp;msg-params))]
                </span><br/>
<span class="covered" title="14 out of 14 forms covered">
                 504&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(or&nbsp;(nil?&nbsp;perm-cb)&nbsp;(authorized?&nbsp;sess-id&nbsp;:subscribe&nbsp;topic&nbsp;perm-cb))
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 505&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-subscribe&nbsp;on-sub-cbs&nbsp;sess-id&nbsp;topic)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 506&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 507&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6&nbsp;;TYPE-ID-UNSUBSCRIBE
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 508&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[topic&nbsp;(get-topic&nbsp;sess-id&nbsp;(first&nbsp;msg-params))]
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 509&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(dosync
                </span><br/>
<span class="covered" title="12 out of 12 forms covered">
                 510&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(true?&nbsp;(get-in&nbsp;@topic-clients&nbsp;[topic&nbsp;sess-id]))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 511&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(topic-unsubscribe&nbsp;topic&nbsp;sess-id)
                </span><br/>
<span class="covered" title="9 out of 9 forms covered">
                 512&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(fn?&nbsp;on-unsub-cb)&nbsp;(on-unsub-cb&nbsp;sess-id&nbsp;topic)))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 513&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 514&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7&nbsp;;TYPE-ID-PUBLISH
                </span><br/>
<span class="covered" title="2 out of 2 forms covered">
                 515&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[[topic-uri&nbsp;event&nbsp;&&nbsp;pub-args]&nbsp;msg-params
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 516&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;topic&nbsp;(get-topic&nbsp;sess-id&nbsp;topic-uri)]
                </span><br/>
<span class="covered" title="14 out of 14 forms covered">
                 517&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(or&nbsp;(nil?&nbsp;perm-cb)&nbsp;(authorized?&nbsp;sess-id&nbsp;:publish&nbsp;topic&nbsp;perm-cb))
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 518&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(apply&nbsp;on-publish&nbsp;on-pub-cbs&nbsp;sess-id&nbsp;topic&nbsp;event&nbsp;pub-args)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 519&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 520&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;default:&nbsp;Unknown&nbsp;message&nbsp;type
                </span><br/>
<span class="covered" title="18 out of 18 forms covered">
                 521&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(log/warn&nbsp;"Unknown&nbsp;message&nbsp;type"&nbsp;data)))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 522&nbsp;&nbsp;
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 523&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 524&nbsp;&nbsp;(defn&nbsp;http-kit-handler
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 525&nbsp;&nbsp;&nbsp;&nbsp;"Sets&nbsp;up&nbsp;the&nbsp;necessary&nbsp;http-kit&nbsp;websocket&nbsp;event&nbsp;handlers
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 526&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;use&nbsp;with&nbsp;the&nbsp;WAMP&nbsp;sub-protocol.&nbsp;Returns&nbsp;a&nbsp;WAMP&nbsp;client&nbsp;session&nbsp;id.
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 527&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 528&nbsp;&nbsp;&nbsp;&nbsp;Example&nbsp;usage:
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 529&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 530&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(http-kit/with-channel&nbsp;req&nbsp;channel
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 531&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if-not&nbsp;(:websocket?&nbsp;req)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 532&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(http-kit/close&nbsp;channel)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 533&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(http-kit-handler&nbsp;channel
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 534&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:on-open&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-open-fn
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 535&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:on-close&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-close-fn
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 536&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 537&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:on-auth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:allow-anon?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;false&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;allow&nbsp;anonymous&nbsp;authentication?
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 538&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:timeout&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;default&nbsp;is&nbsp;20&nbsp;secs
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 539&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:secret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auth-secret-fn
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 540&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:permissions&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auth-permissions-fn}
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 541&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 542&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:on-call&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{(rpc-url&nbsp;\"add\")&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;map&nbsp;topics&nbsp;to&nbsp;rpc&nbsp;functions
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 543&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rpc-url&nbsp;\"echo\")&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;identity
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 544&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:on-before&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-before-call-fn
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 545&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:on-after-error&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-after-call-error-fn
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 546&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:on-after-success&nbsp;&nbsp;&nbsp;&nbsp;on-after-call-success-fn}
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 547&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 548&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:on-subscribe&nbsp;&nbsp;&nbsp;{(evt-url&nbsp;\"chat\")&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-subscribe-fn?&nbsp;;&nbsp;allowed&nbsp;to&nbsp;subscribe?
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 549&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(evt-url&nbsp;\"prefix*\")&nbsp;&nbsp;true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;match&nbsp;topics&nbsp;by&nbsp;prefix
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 550&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(evt-url&nbsp;\"sub-only\")&nbsp;true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;implicitly&nbsp;allowed
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 551&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(evt-url&nbsp;\"pub-only\")&nbsp;false&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;subscription&nbsp;is&nbsp;denied
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 552&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:on-after&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-after-subscribe-fn};
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 553&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 554&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:on-publish&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{(evt-url&nbsp;\"chat\")&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-publish-fn&nbsp;&nbsp;&nbsp;;&nbsp;custom&nbsp;event&nbsp;broker
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 555&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(evt-url&nbsp;\"prefix*\")&nbsp;&nbsp;true&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;pass&nbsp;events&nbsp;through&nbsp;as-is
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 556&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(evt-url&nbsp;\"sub-only\")&nbsp;false&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;publishing&nbsp;is&nbsp;denied
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 557&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(evt-url&nbsp;\"pub-only\")&nbsp;true
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 558&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:on-after&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on-after-publish-fn}
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 559&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 560&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:on-unsubscribe&nbsp;on-unsubscribe-fn})))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 561&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 562&nbsp;&nbsp;&nbsp;&nbsp;Callback&nbsp;signatures:
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 563&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 564&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-open-fn&nbsp;sess-id)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 565&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-close-fn&nbsp;sess-id&nbsp;status)
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 566&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 567&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(auth-secret-fn&nbsp;sess-id&nbsp;auth-key&nbsp;auth-extra)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 568&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Provide&nbsp;the&nbsp;authentication&nbsp;secret&nbsp;for&nbsp;the&nbsp;key&nbsp;(ie.&nbsp;username)&nbsp;and
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 569&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(optionally)&nbsp;extra&nbsp;information&nbsp;from&nbsp;the&nbsp;client.&nbsp;Return&nbsp;nil&nbsp;if&nbsp;the&nbsp;key
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 570&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;does&nbsp;not&nbsp;exist.
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 571&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 572&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(auth-permissions-fn&nbsp;sess-id&nbsp;auth-key)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 573&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns&nbsp;a&nbsp;map&nbsp;of&nbsp;permissions&nbsp;the&nbsp;session&nbsp;is&nbsp;granted&nbsp;when&nbsp;the&nbsp;authentication
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 574&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;succeeds&nbsp;for&nbsp;the&nbsp;given&nbsp;key.
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 575&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 576&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;permission&nbsp;map&nbsp;should&nbsp;be&nbsp;comprised&nbsp;of&nbsp;the&nbsp;topics&nbsp;that&nbsp;are&nbsp;allowed
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 577&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;each&nbsp;category:
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 578&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 579&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:rpc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\"http://example/rpc#call\"&nbsp;&nbsp;&nbsp;&nbsp;true}
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 580&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:subscribe&nbsp;{\"http://example/event#allow\"&nbsp;true
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 581&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\"http://example/event#deny\"&nbsp;&nbsp;false}
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 582&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:publish&nbsp;&nbsp;&nbsp;{\"http://example/event#allow\"&nbsp;true}}
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 583&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 584&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(rpc-call&nbsp;...)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 585&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Can&nbsp;have&nbsp;any&nbsp;signature.&nbsp;The&nbsp;parameters&nbsp;received&nbsp;from&nbsp;the&nbsp;client&nbsp;will&nbsp;be&nbsp;applied&nbsp;as-is.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 586&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;client&nbsp;session&nbsp;is&nbsp;also&nbsp;available&nbsp;in&nbsp;the&nbsp;bound&nbsp;*call-sess-id*&nbsp;var.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 587&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;function&nbsp;may&nbsp;return&nbsp;a&nbsp;value&nbsp;as&nbsp;is,&nbsp;or&nbsp;in&nbsp;a&nbsp;result&nbsp;map:&nbsp;{:result&nbsp;\"my&nbsp;result\"},
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 588&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or&nbsp;as&nbsp;an&nbsp;error&nbsp;map:&nbsp;{:error&nbsp;{:uri&nbsp;\"http://example.com/error#give-error\"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 589&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:message&nbsp;\"Test&nbsp;error\"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 590&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:description&nbsp;\"Test&nbsp;error&nbsp;description\"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 591&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:kill&nbsp;false}}&nbsp;;&nbsp;true&nbsp;will&nbsp;close&nbsp;the&nbsp;connection&nbsp;after&nbsp;send
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 592&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 593&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-before-call-fn&nbsp;sess-id&nbsp;topic&nbsp;call-id&nbsp;call-params)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 594&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;To&nbsp;allow&nbsp;call,&nbsp;return&nbsp;params&nbsp;as&nbsp;vector:&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;call-params]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 595&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;To&nbsp;deny,&nbsp;return&nbsp;nil/false.
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 596&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 597&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-after-call-error-fn&nbsp;sess-id&nbsp;topic&nbsp;call-id&nbsp;error)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 598&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Return&nbsp;params&nbsp;as&nbsp;vector:&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;error]
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 599&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 600&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-after-call-success-fn&nbsp;sess-id&nbsp;topic&nbsp;call-id&nbsp;result)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 601&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Return&nbsp;params&nbsp;as&nbsp;vector:&nbsp;[sess-id&nbsp;topic&nbsp;call-id&nbsp;result]
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 602&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 603&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-subscribe-fn?&nbsp;sess-id&nbsp;topic)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 604&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Return&nbsp;true&nbsp;to&nbsp;allow&nbsp;client&nbsp;to&nbsp;subscribe,&nbsp;false&nbsp;to&nbsp;deny.
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 605&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 606&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-after-subscribe-fn&nbsp;sess-id&nbsp;topic)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 607&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;No&nbsp;return&nbsp;values&nbsp;required.
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 608&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 609&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-publish-fn&nbsp;sess-id&nbsp;topic&nbsp;event&nbsp;exclude&nbsp;eligible)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 610&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;To&nbsp;allow&nbsp;publish,&nbsp;return&nbsp;params&nbsp;as&nbsp;vector:&nbsp;[sess-id&nbsp;topic&nbsp;event&nbsp;exclude&nbsp;eligible]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 611&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;To&nbsp;deny,&nbsp;return&nbsp;nil/false.
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 612&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 613&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-after-publish-fn&nbsp;sess-id&nbsp;topic&nbsp;event&nbsp;exclude&nbsp;eligible)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 614&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;No&nbsp;return&nbsp;values&nbsp;required.
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 615&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 616&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(on-unsubscribe-fn&nbsp;sess-id&nbsp;topic)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 617&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;No&nbsp;return&nbsp;values&nbsp;required."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 618&nbsp;&nbsp;&nbsp;&nbsp;[channel&nbsp;callbacks-map]
                </span><br/>
<span class="covered" title="5 out of 5 forms covered">
                 619&nbsp;&nbsp;&nbsp;&nbsp;(let&nbsp;[callbacks-map&nbsp;(init-cr-auth&nbsp;callbacks-map)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 620&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cb-on-open&nbsp;&nbsp;&nbsp;&nbsp;(callbacks-map&nbsp;:on-open)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 621&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sess-id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(add-client&nbsp;channel)]
                </span><br/>
<span class="covered" title="6 out of 6 forms covered">
                 622&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(httpkit/on-close&nbsp;channel&nbsp;&nbsp;&nbsp;(on-close&nbsp;sess-id
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 623&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(callbacks-map&nbsp;:on-close)
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 624&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(callbacks-map&nbsp;:on-unsubscribe)))
                </span><br/>
<span class="covered" title="7 out of 7 forms covered">
                 625&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(httpkit/on-receive&nbsp;channel&nbsp;(on-message&nbsp;sess-id&nbsp;callbacks-map))
                </span><br/>
<span class="covered" title="3 out of 3 forms covered">
                 626&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(send-welcome!&nbsp;sess-id)
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 627&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(when&nbsp;(fn?&nbsp;cb-on-open)&nbsp;(cb-on-open&nbsp;sess-id))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 628&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(init-auth-timer&nbsp;callbacks-map&nbsp;sess-id)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 629&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sess-id))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 630&nbsp;&nbsp;
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 631&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 632&nbsp;&nbsp;(defn&nbsp;origin-match?
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 633&nbsp;&nbsp;&nbsp;&nbsp;"Compares&nbsp;a&nbsp;regular&nbsp;expression&nbsp;against&nbsp;the&nbsp;Origin:&nbsp;header.
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 634&nbsp;&nbsp;&nbsp;&nbsp;Used&nbsp;to&nbsp;help&nbsp;protect&nbsp;against&nbsp;CSRF,&nbsp;but&nbsp;do&nbsp;not&nbsp;depend&nbsp;on&nbsp;just
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 635&nbsp;&nbsp;&nbsp;&nbsp;this&nbsp;check.&nbsp;Best&nbsp;to&nbsp;use&nbsp;a&nbsp;server-generated&nbsp;CSRF&nbsp;token&nbsp;for&nbsp;comparison."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 636&nbsp;&nbsp;&nbsp;&nbsp;[origin-re&nbsp;req]
                </span><br/>
<span class="covered" title="12 out of 12 forms covered">
                 637&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[req-origin&nbsp;(get-in&nbsp;req&nbsp;[:headers&nbsp;"origin"])]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 638&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(re-matches&nbsp;origin-re&nbsp;req-origin)))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 639&nbsp;&nbsp;
                </span><br/>
<span class="covered" title="1 out of 1 forms covered">
                 640&nbsp;&nbsp;(defn&nbsp;subprotocol?
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 641&nbsp;&nbsp;&nbsp;&nbsp;"Checks&nbsp;if&nbsp;a&nbsp;protocol&nbsp;string&nbsp;exists&nbsp;in&nbsp;the&nbsp;Sec-WebSocket-Protocol
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 642&nbsp;&nbsp;&nbsp;&nbsp;list&nbsp;header."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 643&nbsp;&nbsp;&nbsp;&nbsp;[proto&nbsp;req]
                </span><br/>
<span class="covered" title="12 out of 12 forms covered">
                 644&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[protocols&nbsp;(get-in&nbsp;req&nbsp;[:headers&nbsp;"sec-websocket-protocol"])]
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 645&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(some&nbsp;#{proto}
                </span><br/>
<span class="covered" title="8 out of 8 forms covered">
                 646&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(map&nbsp;#(lower-case&nbsp;(trim&nbsp;%))
                </span><br/>
<span class="covered" title="4 out of 4 forms covered">
                 647&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(split&nbsp;protocols&nbsp;#",")))))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 648&nbsp;&nbsp;
                </span><br/>
<span class="partial" title="5 out of 315 forms covered">
                 649&nbsp;&nbsp;(defmacro&nbsp;with-channel-validation
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 650&nbsp;&nbsp;&nbsp;&nbsp;"Replaces&nbsp;HTTP&nbsp;Kit&nbsp;with-channel&nbsp;macro&nbsp;to&nbsp;do&nbsp;extra&nbsp;validation
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 651&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;the&nbsp;wamp&nbsp;subprotocol&nbsp;and&nbsp;allowed&nbsp;origin&nbsp;URLs.
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 652&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 653&nbsp;&nbsp;&nbsp;&nbsp;Example&nbsp;usage:
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 654&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 655&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(defn&nbsp;my-wamp-handler&nbsp;[request]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 656&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(wamp/with-channel-validation&nbsp;request&nbsp;channel&nbsp;#\"https?://myhost\"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 657&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(wamp/http-kit-handler&nbsp;channel&nbsp;{&nbsp;...&nbsp;})))
                </span><br/>
<span class="blank" title="0 out of 0 forms covered">
                 658&nbsp;&nbsp;
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 659&nbsp;&nbsp;&nbsp;&nbsp;See&nbsp;org.httpkit.server&nbsp;for&nbsp;more&nbsp;information."
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 660&nbsp;&nbsp;&nbsp;&nbsp;[request&nbsp;ch-name&nbsp;origin-re&nbsp;&&nbsp;body]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 661&nbsp;&nbsp;&nbsp;&nbsp;`(let&nbsp;[~ch-name&nbsp;(:async-channel&nbsp;~request)]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 662&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(:websocket?&nbsp;~request)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 663&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if-let&nbsp;[key#&nbsp;(get-in&nbsp;~request&nbsp;[:headers&nbsp;"sec-websocket-key"])]
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 664&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(origin-match?&nbsp;~origin-re&nbsp;~request)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 665&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;(subprotocol?&nbsp;"wamp"&nbsp;~request)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 666&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(do
                </span><br/>
<span class="not-covered" title="0 out of 6 forms covered">
                 667&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(.sendHandshake&nbsp;~(with-meta&nbsp;ch-name&nbsp;{:tag&nbsp;`AsyncChannel})
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 668&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{"Upgrade"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"websocket"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 669&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Connection"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Upgrade"
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 670&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sec-WebSocket-Accept"&nbsp;&nbsp;&nbsp;(httpkit/accept&nbsp;key#)
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 671&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sec-WebSocket-Protocol"&nbsp;"wamp"})
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 672&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~@body
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 673&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:body&nbsp;~ch-name})
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 674&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:status&nbsp;400&nbsp;:body&nbsp;"missing&nbsp;or&nbsp;bad&nbsp;WebSocket-Protocol"})
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 675&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:status&nbsp;400&nbsp;:body&nbsp;"missing&nbsp;or&nbsp;bad&nbsp;WebSocket-Origin"})
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 676&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:status&nbsp;400&nbsp;:body&nbsp;"missing&nbsp;or&nbsp;bad&nbsp;WebSocket-Key"})
                </span><br/>
<span class="not-tracked" title="0 out of 0 forms covered">
                 677&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{:status&nbsp;400&nbsp;:body&nbsp;"not&nbsp;websocket&nbsp;protocol"})))
                </span><br/>
 </body>
</html>
