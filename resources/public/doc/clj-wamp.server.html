<!DOCTYPE html>
<html><head><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>clj-wamp.server documentation</title></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html">Clj-wamp 1.0.0-beta3 API documentation</a></h1></div><div class="sidebar" id="namespaces"><h3><span>Namespaces</span></h3><ul><li class="current"><a href="clj-wamp.server.html"><span>clj-wamp.server</span></a></li></ul></div><div class="sidebar" id="vars"><h3>Public Vars</h3><ul><li><a href="clj-wamp.server.html#var-add-client"><span>add-client</span></a></li><li><a href="clj-wamp.server.html#var-add-topic-prefix"><span>add-topic-prefix</span></a></li><li><a href="clj-wamp.server.html#var-broadcast-event%21"><span>broadcast-event!</span></a></li><li><a href="clj-wamp.server.html#var-del-client"><span>del-client</span></a></li><li><a href="clj-wamp.server.html#var-emit-event%21"><span>emit-event!</span></a></li><li><a href="clj-wamp.server.html#var-get-client-channel"><span>get-client-channel</span></a></li><li><a href="clj-wamp.server.html#var-get-topic"><span>get-topic</span></a></li><li><a href="clj-wamp.server.html#var-http-kit-handler"><span>http-kit-handler</span></a></li><li><a href="clj-wamp.server.html#var-origin-match%3F"><span>origin-match?</span></a></li><li><a href="clj-wamp.server.html#var-send-call-error%21"><span>send-call-error!</span></a></li><li><a href="clj-wamp.server.html#var-send-call-result%21"><span>send-call-result!</span></a></li><li><a href="clj-wamp.server.html#var-send-event%21"><span>send-event!</span></a></li><li><a href="clj-wamp.server.html#var-send-welcome%21"><span>send-welcome!</span></a></li><li><a href="clj-wamp.server.html#var-subprotocol%3F"><span>subprotocol?</span></a></li><li><a href="clj-wamp.server.html#var-topic-subscribe"><span>topic-subscribe</span></a></li><li><a href="clj-wamp.server.html#var-topic-unsubscribe"><span>topic-unsubscribe</span></a></li><li><a href="clj-wamp.server.html#var-with-channel-validation"><span>with-channel-validation</span></a></li></ul></div><div class="namespace-docs" id="content"><h2>clj-wamp.server documentation</h2><pre class="doc"></pre><div class="public" id="var-add-client"><h3>add-client</h3><div class="usage"><code>(add-client channel-or-fn)</code></div><pre class="doc">Adds a websocket channel (or callback function) to a map of clients
and returns a unique session id.</pre></div><div class="public" id="var-add-topic-prefix"><h3>add-topic-prefix</h3><div class="usage"><code>(add-topic-prefix sess-id prefix uri)</code></div><pre class="doc">Adds a new CURI topic prefix for a websocket client.
</pre></div><div class="public" id="var-broadcast-event%21"><h3>broadcast-event!</h3><div class="usage"><code>(broadcast-event! topic event excludes)</code></div><pre class="doc">Sends an event message to all clients in a topic but those excluded.
</pre></div><div class="public" id="var-del-client"><h3>del-client</h3><div class="usage"><code>(del-client sess-id)</code></div><pre class="doc">Removes a websocket session from the map of clients.
</pre></div><div class="public" id="var-emit-event%21"><h3>emit-event!</h3><div class="usage"><code>(emit-event! topic event includes)</code></div><pre class="doc">Sends an event message to specific clients in a topic
</pre></div><div class="public" id="var-get-client-channel"><h3>get-client-channel</h3><div class="usage"><code>(get-client-channel sess-id)</code></div><pre class="doc">Returns the channel (or callback function) for a websocket client's
session id.</pre></div><div class="public" id="var-get-topic"><h3>get-topic</h3><div class="usage"><code>(get-topic sess-id curi)</code></div><pre class="doc">Returns the full topic URI for a prefix. If prefix does not exist,
returns the CURI passed in.</pre></div><div class="public" id="var-http-kit-handler"><h3>http-kit-handler</h3><div class="usage"><code>(http-kit-handler channel callbacks-map)</code></div><pre class="doc">Sets up the necessary http-kit websocket event handlers
for use with the WAMP sub-protocol. Returns a WAMP client session id.

Example usage:

  (http-kit/with-channel req channel
    (if-not (:websocket? req)
      (http-kit/close channel)
      (http-kit-handler channel
        {:on-open        on-open-fn
         :on-close       on-close-fn

         :on-call        {(rpc-url &quot;add&quot;)      +         ; map topics to rpc functions
                          (rpc-url &quot;echo&quot;)     identity
                          :on-before           on-before-call-fn
                          :on-after-error      on-after-call-error-fn
                          :on-after-success    on-after-call-success-fn}

         :on-subscribe   {(evt-url &quot;chat&quot;)     on-subscribe-fn? ; allowed to subscribe?
                          (evt-url &quot;prefix*&quot;)  true             ; match topics by prefix
                          (evt-url &quot;sub-only&quot;) true             ; implicitly allowed
                          (evt-url &quot;pub-only&quot;) false            ; subscription is denied
                          :on-after            on-after-subscribe-fn};

         :on-publish     {(evt-url &quot;chat&quot;)     on-publish-fn   ; custom event broker
                          (evt-url &quot;prefix*&quot;)  true            ; pass events through as-is
                          (evt-url &quot;sub-only&quot;) false           ; publishing is denied
                          (evt-url &quot;pub-only&quot;) true
                          :on-after            on-after-publish-fn}

         :on-unsubscribe on-unsubscribe-fn})))

Callback signatures:

  (on-open-fn sess-id)
  (on-close-fn sess-id status)

  (rpc-call ...)
    Can have any signature. The parameters received from the client will be applied as-is.
    The client session is also available in the bound *call-sess-id* var.
    The function may return a value as is, or in a result map: {:result &quot;my result&quot;},
    or as an error map: {:error {:uri &quot;http://example.com/error#give-error&quot;
                                 :message &quot;Test error&quot;
                                 :description &quot;Test error description&quot;}}

  (on-before-call-fn sess-id topic call-id call-params)
    To allow call, return params as vector: [sess-id topic call-id call-params]
    To deny, return nil/false.

  (on-after-call-error-fn sess-id topic call-id error)
    Return params as vector: [sess-id topic call-id error]

  (on-after-call-success-fn sess-id topic call-id result)
    Return params as vector: [sess-id topic call-id result]

  (on-subscribe-fn? sess-id topic)
    Return true to allow client to subscribe, false to deny.

  (on-after-subscribe-fn sess-id topic)
    No return values required.

  (on-publish-fn sess-id topic event exclude eligible)
    To allow publish, return params as vector: [sess-id topic event exclude eligible]
    To deny, return nil/false.

  (on-after-publish-fn sess-id topic event exclude eligible)
    No return values required.

  (on-unsubscribe-fn sess-id topic)
    No return values required.</pre></div><div class="public" id="var-origin-match%3F"><h3>origin-match?</h3><div class="usage"><code>(origin-match? origin-re req)</code></div><pre class="doc">Compares a regular expression against the Origin: header.
Used to help protect against CSRF.</pre></div><div class="public" id="var-send-call-error%21"><h3>send-call-error!</h3><div class="usage"><code>(send-call-error! sess-id call-id err-uri err-desc)</code><code>(send-call-error! sess-id call-id err-uri err-desc err-details)</code></div><pre class="doc">Sends a WAMP call error message to a websocket client.
[ TYPE_ID_CALLERROR , callID , errorURI , errorDesc [, errorDetails] ]</pre></div><div class="public" id="var-send-call-result%21"><h3>send-call-result!</h3><div class="usage"><code>(send-call-result! sess-id call-id result)</code></div><pre class="doc">Sends a WAMP call result message to a websocket client.
[ TYPE_ID_CALLRESULT , callID , result ]</pre></div><div class="public" id="var-send-event%21"><h3>send-event!</h3><div class="usage"><code>(send-event! topic event)</code></div><pre class="doc">Sends an event message to all clients in topic.
[ TYPE_ID_EVENT , topicURI , event ]</pre></div><div class="public" id="var-send-welcome%21"><h3>send-welcome!</h3><div class="usage"><code>(send-welcome! sess-id)</code><code>(send-welcome! sess-id protocol-ver server-ident)</code></div><pre class="doc">Sends a WAMP welcome message to a websocket client.
[ TYPE_ID_WELCOME , sessionId , protocolVersion, serverIdent ]</pre></div><div class="public" id="var-subprotocol%3F"><h3>subprotocol?</h3><div class="usage"><code>(subprotocol? proto req)</code></div><pre class="doc">Checks if a protocol string exists in the Sec-WebSocket-Protocol
list header.</pre></div><div class="public" id="var-topic-subscribe"><h3>topic-subscribe</h3><div class="usage"><code>(topic-subscribe topic sess-id)</code></div><pre class="doc">Subscribes a websocket session to a topic.
</pre></div><div class="public" id="var-topic-unsubscribe"><h3>topic-unsubscribe</h3><div class="usage"><code>(topic-unsubscribe topic sess-id)</code></div><pre class="doc">Unsubscribes a websocket session from a topic.
</pre></div><div class="public" id="var-with-channel-validation"><h3>with-channel-validation</h3><h4 class="macro">macro</h4><div class="usage"><code>(with-channel-validation request ch-name origin-re &amp; body)</code></div><pre class="doc">Replaces HTTP Kit with-channel macro to do extra validation
for the wamp subprotocol and allowed origin URLs.

(defn my-wamp-handler [request]
  (wamp/with-channel-validation request channel #&quot;https?://myhost&quot;
    (wamp/http-kit-handler channel { ... })))

See org.httpkit.server for more information.</pre></div></div></body></html>